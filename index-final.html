<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Search Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .button-secondary:hover {
            background: #f8f9ff;
        }

        .button-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .upload-option {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .upload-option button {
            flex: 1;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-upload:hover {
            background-color: #f8f9ff;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .profile-review {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .profile-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .profile-section:last-child {
            border-bottom: none;
        }

        .profile-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .match-result {
            background: white;
            border-left: 4px solid #667eea;
            padding: 25px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .match-percentage {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        .match-details {
            margin: 20px 0;
        }

        .match-details h3 {
            color: #555;
            margin-bottom: 10px;
        }

        .match-details ul {
            list-style-position: inside;
            padding-left: 0;
        }

        .match-details li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .alert-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #1565c0;
        }

        .alert-success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }

        .alert-warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            color: #e65100;
        }

        .alert-error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .document-output {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 6px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .ats-score {
            background: white;
            border: 2px solid #4caf50;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .ats-score h3 {
            color: #4caf50;
            margin-bottom: 10px;
        }

        .question-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .hidden {
            display: none;
        }

        .settings-link {
            text-align: right;
            margin-bottom: 20px;
        }

        .settings-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .settings-link a:hover {
            text-decoration: underline;
        }

        .api-setup {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 6px;
            padding: 25px;
            margin: 20px 0;
        }

        .api-setup h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }

        .api-setup ol {
            margin: 15px 0 15px 20px;
        }

        .api-setup li {
            margin: 8px 0;
        }

        .cost-estimate {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ AI Job Search Assistant</h1>
            <p>Powered by Claude AI - Real intelligent job matching</p>
        </div>

        <div class="content">
            <!-- API Key Setup Section -->
            <div id="api-setup-section" class="section active">
                <h2>Welcome to Your Job Search Assistant!</h2>
                <p style="margin: 20px 0;">This tool uses Claude AI to provide intelligent job matching and resume generation.</p>
                
                <div class="alert alert-info">
                    <h3>‚ú® What This Tool Does:</h3>
                    <ul style="margin: 15px 0 15px 20px;">
                        <li>Analyzes job postings against your professional profile</li>
                        <li>Provides match percentages with detailed insights</li>
                        <li>Generates tailored resumes for each position</li>
                        <li>Creates customized cover letters</li>
                        <li>Optimized for ATS (Applicant Tracking Systems)</li>
                    </ul>
                </div>

                <button class="button" onclick="skipApiSetup()">Get Started</button>
            </div>

            <!-- Welcome Section -->
            <div id="welcome-section" class="section">
                <h2>Welcome Back!</h2>
                <p style="margin: 20px 0;">Ready to analyze jobs and generate tailored resumes. Let's set up your professional profile.</p>
                <button class="button" onclick="startProfileSetup()">Set Up My Profile</button>
            </div>

            <!-- Profile Setup - Contact Info -->
            <div id="contact-section" class="section">
                <h2>Contact Information</h2>
                <div class="form-group">
                    <label for="fullName">Full Name *</label>
                    <input type="text" id="fullName" required>
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="tel" id="phone">
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="City, State">
                </div>
                <div class="form-group">
                    <label for="linkedin">LinkedIn URL</label>
                    <input type="text" id="linkedin">
                </div>
                <button class="button" onclick="saveContactInfo()">Continue</button>
            </div>

            <!-- Profile Setup - Data Entry Method -->
            <div id="data-method-section" class="section">
                <h2>Professional Information</h2>
                <p style="margin: 20px 0;">How would you like to provide your professional information?</p>
                <div class="upload-option">
                    <button class="button" onclick="chooseManualEntry()">Enter Manually</button>
                    <button class="button button-secondary" onclick="chooseDocumentUpload()">Upload Documents</button>
                </div>
            </div>

            <!-- Manual Entry Section -->
            <div id="manual-entry-section" class="section">
                <h2>Tell Us About Your Experience</h2>
                <div id="manual-questions"></div>
            </div>

            <!-- Document Upload Section -->
            <div id="upload-section" class="section">
                <h2>Upload Your Documents</h2>
                <p style="margin: 20px 0;">Upload your resume, CV, or other documents. We'll extract the relevant information.</p>
                <div class="file-upload" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" accept=".pdf,.doc,.docx,.txt" multiple onchange="handleFileUpload(event)">
                    <p>üìÑ Click to upload documents (PDF, DOCX, TXT)</p>
                    <p style="font-size: 0.9em; color: #888; margin-top: 10px;">You can upload multiple files</p>
                </div>
                <div id="upload-status" class="hidden"></div>
            </div>

            <!-- Profile Review Section -->
            <div id="review-section" class="section">
                <h2>Review Your Profile</h2>
                <div id="profile-display" class="profile-review"></div>
                <div class="button-group">
                    <button class="button button-secondary" onclick="editProfile()">Edit</button>
                    <button class="button" onclick="confirmProfile()">Confirm</button>
                </div>
            </div>

            <!-- Job Analysis Section -->
            <div id="job-section" class="section">
                <h2>Analyze a Job Posting</h2>
                <div class="form-group">
                    <label for="jobInput">Paste Job Description</label>
                    <textarea id="jobInput" placeholder="Paste the full job description here..."></textarea>
                    <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Note: This tool cannot fetch web links. Please copy and paste the job description text.</p>
                </div>
                <button class="button" id="analyzeButton" onclick="analyzeJob()">Analyze Job Match</button>
                <div id="analysis-result" style="margin-top: 30px;"></div>
            </div>

        </div>
    </div>

    <script>
        // Storage keys
        const STORAGE_KEY = 'job-search-profile';

        // Profile data
        let profileData = {
            contact: {},
            workExperience: '',
            skills: '',
            certifications: '',
            education: '',
            achievements: ''
        };

        let currentJobDescription = '';

        // Manual entry questions
        const manualQuestions = [
            { id: 'workExperience', label: 'Work Experience', placeholder: 'List your work experience, including job titles, companies, dates, and key responsibilities...' },
            { id: 'skills', label: 'Skills', placeholder: 'List your technical and soft skills...' },
            { id: 'certifications', label: 'Certifications', placeholder: 'List any certifications, licenses, or professional credentials...' },
            { id: 'education', label: 'Education', placeholder: 'List your educational background, including degrees, institutions, and dates...' },
            { id: 'achievements', label: 'Key Achievements', placeholder: 'Highlight notable achievements, awards, or accomplishments...' }
        ];

        let currentQuestionIndex = 0;

        // Initialize
        window.onload = function() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            loadData();
        };

        function loadData() {
            // Load profile
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                profileData = JSON.parse(saved);
            }

            // Determine which section to show
            if (!profileData.contact.name) {
                showSection('api-setup-section');
            } else {
                showSection('job-section');
            }
        }

        function skipApiSetup() {
            showSection('welcome-section');
        }

        function clearAllData() {
            if (confirm('This will delete your profile. Are you sure?')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function backToJob() {
            showSection('job-section');
        }

        function saveProfile() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(profileData));
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        function startProfileSetup() {
            showSection('contact-section');
        }

        function saveContactInfo() {
            profileData.contact = {
                name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value,
                linkedin: document.getElementById('linkedin').value
            };

            if (!profileData.contact.name || !profileData.contact.email) {
                alert('Please provide at least your name and email.');
                return;
            }

            showSection('data-method-section');
        }

        function chooseManualEntry() {
            currentQuestionIndex = 0;
            showManualQuestion();
            showSection('manual-entry-section');
        }

        function showManualQuestion() {
            const container = document.getElementById('manual-questions');
            const question = manualQuestions[currentQuestionIndex];
            
            container.innerHTML = `
                <div class="form-group">
                    <label for="${question.id}">${question.label}</label>
                    <textarea id="${question.id}" placeholder="${question.placeholder}">${profileData[question.id] || ''}</textarea>
                </div>
                <div class="button-group">
                    ${currentQuestionIndex > 0 ? '<button class="button button-secondary" onclick="previousQuestion()">Previous</button>' : ''}
                    <button class="button" onclick="nextQuestion()">
                        ${currentQuestionIndex < manualQuestions.length - 1 ? 'Next' : 'Review Profile'}
                    </button>
                </div>
            `;
        }

        function previousQuestion() {
            saveCurrentAnswer();
            currentQuestionIndex--;
            showManualQuestion();
        }

        function nextQuestion() {
            saveCurrentAnswer();
            if (currentQuestionIndex < manualQuestions.length - 1) {
                currentQuestionIndex++;
                showManualQuestion();
            } else {
                displayProfileForReview();
                showSection('review-section');
            }
        }

        function saveCurrentAnswer() {
            const question = manualQuestions[currentQuestionIndex];
            profileData[question.id] = document.getElementById(question.id).value;
        }

        function chooseDocumentUpload() {
            showSection('upload-section');
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            const statusDiv = document.getElementById('upload-status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing documents...</p></div>';

            let extractedText = '';

            for (let file of files) {
                try {
                    let text = '';
                    if (file.type === 'application/pdf') {
                        text = await extractTextFromPDF(file);
                    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        text = await extractTextFromDOCX(file);
                    } else if (file.type === 'text/plain') {
                        text = await file.text();
                    }
                    extractedText += text + '\n\n';
                } catch (error) {
                    console.error('Error processing file:', error);
                }
            }

            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing and categorizing your information with AI...</p></div>';

            // Parse the extracted text with AI
            await parseExtractedText(extractedText);
            
            displayProfileForReview();
            
            statusDiv.innerHTML = '<div class="alert alert-success">Documents processed and organized successfully!</div>';
            setTimeout(() => {
                showSection('review-section');
            }, 1500);
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            
            return text;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        async function parseExtractedText(text) {
            // Check text size - warn if very large
            const estimatedTokens = text.length / 4; // Rough estimate: 1 token ‚âà 4 chars
            if (estimatedTokens > 30000) {
                alert('Warning: Uploaded documents are very large. Parsing may take longer or fail. Consider using smaller files or manual entry.');
            }

            // Use Claude API to intelligently parse the document(s)
            try {
                const systemPrompt = `You are an expert at extracting and organizing professional information from resumes and CVs. 

IMPORTANT: The user may have uploaded MULTIPLE documents (different resume versions, cover letters, etc.). Your job is to:
1. Review ALL the content provided
2. DEDUPLICATE any repetitive information
3. Extract the MOST COMPLETE and RECENT version of each piece of information
4. Organize into clean, consolidated sections

Extract and categorize into these SPECIFIC categories:

1. workExperience: ONLY job titles, company names, employment dates, responsibilities, and achievements from actual job positions. If multiple versions exist, use the most detailed/recent one. Do NOT include professional summaries, certifications, education, or skills.

2. skills: ALL unique technical skills, programming languages, tools, platforms, software proficiencies, methodologies mentioned across all documents. Remove duplicates. Extract from "Skills", "Technical Proficiencies", "Core Competencies" sections.

3. certifications: ALL unique professional certifications, licenses, credentials with dates. Remove duplicates. Extract from "Certifications", "Professional Development", "Credentials" sections.

4. education: Degrees, universities, graduation dates. If mentioned multiple times, use the most complete version.

5. achievements: Notable accomplishments with metrics, awards, recognition. Deduplicate and keep only unique achievements.

CRITICAL RULES:
- Do NOT put the entire resume in workExperience
- Remove ALL duplicate information
- Merge similar entries intelligently
- Use the most complete version when information differs
- Separate content properly into the right categories

You MUST return ONLY valid JSON with no additional text. Format:
{"workExperience":"text","skills":"text","certifications":"text","education":"text","achievements":"text"}`;

                const userMessage = `The following text may contain MULTIPLE DOCUMENTS with OVERLAPPING INFORMATION. Please extract, deduplicate, and properly categorize all information:

${text}

Remember: 
- Deduplicate repetitive content
- Use the most complete version of each piece of information
- Separate into the correct categories
- Do NOT dump everything into workExperience

Return ONLY the JSON object, nothing else. No markdown formatting, no explanations.`;

                const response = await callClaudeAPI(systemPrompt, userMessage);
                
                console.log('Parsing API Response:', response); // Debug logging
                
                // Try to extract JSON more carefully
                let parsed = null;
                
                // Method 1: Try direct parse if response is clean JSON
                try {
                    parsed = JSON.parse(response);
                } catch (e) {
                    // Method 2: Extract JSON from markdown code blocks
                    const codeBlockMatch = response.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
                    if (codeBlockMatch) {
                        parsed = JSON.parse(codeBlockMatch[1]);
                    } else {
                        // Method 3: Find first complete JSON object
                        const jsonMatch = response.match(/\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/);
                        if (jsonMatch) {
                            parsed = JSON.parse(jsonMatch[0]);
                        }
                    }
                }
                
                if (!parsed) {
                    throw new Error('Could not extract valid JSON from API response');
                }
                
                // Validate required fields exist
                const requiredFields = ['workExperience', 'skills', 'certifications', 'education', 'achievements'];
                const missingFields = requiredFields.filter(field => !(field in parsed));
                
                if (missingFields.length > 0) {
                    throw new Error(`API response missing fields: ${missingFields.join(', ')}`);
                }
                
                // Validate that parsing actually separated content (not everything in one field)
                const hasContent = (str) => str && str.trim().length > 0;
                const separatedFields = [
                    hasContent(parsed.skills),
                    hasContent(parsed.certifications),
                    hasContent(parsed.education)
                ].filter(Boolean).length;
                
                if (separatedFields === 0 && hasContent(parsed.workExperience)) {
                    throw new Error('AI did not properly separate content into categories - everything appears to be in workExperience');
                }
                
                // Success - update profile data
                profileData.workExperience = parsed.workExperience || '';
                profileData.skills = parsed.skills || '';
                profileData.certifications = parsed.certifications || '';
                profileData.education = parsed.education || '';
                profileData.achievements = parsed.achievements || '';
                
                console.log('Successfully parsed and deduplicated documents');
                console.log('Fields populated:', {
                    workExperience: hasContent(parsed.workExperience),
                    skills: hasContent(parsed.skills),
                    certifications: hasContent(parsed.certifications),
                    education: hasContent(parsed.education),
                    achievements: hasContent(parsed.achievements)
                });
                
            } catch (error) {
                console.error('Error parsing documents:', error);
                console.error('Error details:', error.message);
                
                const errorMsg = error.message.includes('API') ? 
                    'The AI service returned an unexpected response.' : 
                    'Failed to parse the documents.';
                
                alert(`Document parsing encountered an issue: ${errorMsg}\n\nThe content will be placed in Work Experience for you to manually organize.\n\nError details: ${error.message}\n\nPlease check the browser console (F12) for more details, or try manual entry instead.`);
                
                // Fallback: store all text in work experience
                profileData.workExperience = text;
                profileData.skills = '';
                profileData.certifications = '';
                profileData.education = '';
                profileData.achievements = '';
            }
        }

        function displayProfileForReview() {
            const display = document.getElementById('profile-display');
            display.innerHTML = `
                <div class="profile-section">
                    <h3>Contact Information</h3>
                    <p><strong>Name:</strong> ${profileData.contact.name}</p>
                    <p><strong>Email:</strong> ${profileData.contact.email}</p>
                    ${profileData.contact.phone ? `<p><strong>Phone:</strong> ${profileData.contact.phone}</p>` : ''}
                    ${profileData.contact.location ? `<p><strong>Location:</strong> ${profileData.contact.location}</p>` : ''}
                    ${profileData.contact.linkedin ? `<p><strong>LinkedIn:</strong> ${profileData.contact.linkedin}</p>` : ''}
                </div>
                <div class="profile-section">
                    <h3>Work Experience</h3>
                    <p>${profileData.workExperience || 'Not provided'}</p>
                </div>
                <div class="profile-section">
                    <h3>Skills</h3>
                    <p>${profileData.skills || 'Not provided'}</p>
                </div>
                <div class="profile-section">
                    <h3>Certifications</h3>
                    <p>${profileData.certifications || 'Not provided'}</p>
                </div>
                <div class="profile-section">
                    <h3>Education</h3>
                    <p>${profileData.education || 'Not provided'}</p>
                </div>
                <div class="profile-section">
                    <h3>Achievements</h3>
                    <p>${profileData.achievements || 'Not provided'}</p>
                </div>
            `;
        }

        function editProfile() {
            showSection('contact-section');
        }

        function confirmProfile() {
            saveProfile();
            showSection('job-section');
        }

        async function callClaudeAPI(systemPrompt, userMessage) {
            try {
                // Call Netlify function instead of Anthropic API directly
                const netlifyFunctionUrl = 'https://curious-rugelach-e5ffb8.netlify.app/.netlify/functions/claude-proxy';
                
                const response = await fetch(netlifyFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        systemPrompt: systemPrompt,
                        userMessage: userMessage,
                        maxTokens: 4000
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || error.message || 'API request failed');
                }

                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function analyzeJob() {
            const jobInput = document.getElementById('jobInput').value.trim();
            const resultDiv = document.getElementById('analysis-result');
            const analyzeButton = document.getElementById('analyzeButton');

            if (!jobInput) {
                alert('Please provide a job description.');
                return;
            }

            // Check if input is a URL
            const urlPattern = /^(https?:\/\/|www\.)/i;
            if (urlPattern.test(jobInput)) {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h3>‚ö†Ô∏è Cannot Fetch Web Links</h3>
                        <p>This tool cannot directly access web links. To analyze this job posting:</p>
                        <ol style="margin: 15px 0; padding-left: 20px;">
                            <li>Visit the job posting URL in your browser</li>
                            <li>Copy the full job description text</li>
                            <li>Paste it into the text field above</li>
                            <li>Click "Analyze Job Match" again</li>
                        </ol>
                    </div>
                `;
                return;
            }

            currentJobDescription = jobInput;
            analyzeButton.disabled = true;
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing job match with Claude AI...</p></div>';

            try {
                const systemPrompt = `You are an expert HR professional and career advisor. Analyze job postings against candidate profiles with precision and insight.

Your task is to:
1. Calculate an accurate match percentage (0-100%)
2. Identify specific strengths where the candidate matches requirements
3. Identify specific gaps where requirements aren't met
4. Provide actionable insights

CRITICAL WRITING RULES:
- Avoid AI clich√©s like "delve", "dive deep", "unlock", "unleash", "leverage"
- Use simple, direct language
- Keep sentences concise (under 25 words)
- Minimize use of em dashes
- Write naturally, as a human career advisor would

Return your analysis in this exact JSON format:
{
  "matchPercentage": 85,
  "strengths": ["Specific strength 1", "Specific strength 2", ...],
  "gaps": ["Specific gap 1", "Specific gap 2", ...],
  "recommendations": ["Specific recommendation 1", ...]
}`;

                const userMessage = `CANDIDATE PROFILE:
Name: ${profileData.contact.name}
Email: ${profileData.contact.email}
Location: ${profileData.contact.location || 'Not specified'}

WORK EXPERIENCE:
${profileData.workExperience}

SKILLS:
${profileData.skills}

CERTIFICATIONS:
${profileData.certifications}

EDUCATION:
${profileData.education}

ACHIEVEMENTS:
${profileData.achievements}

---

JOB DESCRIPTION:
${jobInput}

---

Analyze this candidate's fit for the job. Be honest about match percentage. Return only valid JSON.`;

                const response = await callClaudeAPI(systemPrompt, userMessage);
                
                console.log('Job analysis API response:', response);
                
                // Try to extract JSON more carefully
                let analysis = null;
                
                // Method 1: Try direct parse if response is clean JSON
                try {
                    analysis = JSON.parse(response);
                } catch (e) {
                    // Method 2: Extract JSON from markdown code blocks
                    const codeBlockMatch = response.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
                    if (codeBlockMatch) {
                        analysis = JSON.parse(codeBlockMatch[1]);
                    } else {
                        // Method 3: Find first complete JSON object
                        const jsonMatch = response.match(/\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/);
                        if (jsonMatch) {
                            analysis = JSON.parse(jsonMatch[0]);
                        }
                    }
                }
                
                if (!analysis) {
                    throw new Error('Could not extract valid JSON from API response');
                }
                
                // Validate required fields
                if (!('matchPercentage' in analysis)) {
                    throw new Error('API response missing matchPercentage field');
                }
                if (!Array.isArray(analysis.strengths)) {
                    analysis.strengths = [];
                }
                if (!Array.isArray(analysis.gaps)) {
                    analysis.gaps = [];
                }
                if (!Array.isArray(analysis.recommendations)) {
                    analysis.recommendations = [];
                }
                
                displayAnalysisResult(analysis);
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h3>‚ùå Error</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px;">Please check your API key and try again.</p>
                    </div>
                `;
            } finally {
                analyzeButton.disabled = false;
            }
        }

        function displayAnalysisResult(analysis) {
            const resultDiv = document.getElementById('analysis-result');
            const score = analysis.matchPercentage;
            
            let content = `
                <div class="match-result">
                    <h3>Match Analysis</h3>
                    <div class="match-percentage">${score}%</div>
            `;

            if (score >= 90) {
                content += `
                    <div class="alert alert-success">
                        <strong>Excellent Match!</strong> You're highly qualified for this position.
                    </div>
                    <div class="match-details">
                        <h3>‚úÖ Strengths</h3>
                        <ul>
                            ${analysis.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                        ${analysis.gaps.length > 0 ? `
                        <h3>‚ö†Ô∏è Minor Gaps</h3>
                        <ul>
                            ${analysis.gaps.map(g => `<li>${g}</li>`).join('')}
                        </ul>
                        ` : ''}
                    </div>
                    <div class="button-group">
                        <button class="button" onclick="generateResume()">Generate Tailored Resume</button>
                    </div>
                `;
            } else if (score >= 80) {
                content += `
                    <div class="alert alert-info">
                        <strong>Strong Match</strong> with some addressable gaps.
                    </div>
                    <div class="match-details">
                        <h3>‚úÖ Strengths</h3>
                        <ul>
                            ${analysis.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                        <h3>üìã Gaps to Address</h3>
                        <ul>
                            ${analysis.gaps.map(g => `<li>${g}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="question-box">
                        <h3>Assessment Questions</h3>
                        <p>To raise your match to 90%+, I need to verify some details:</p>
                        <textarea id="gapAnswers" placeholder="Please provide additional information about your experience with the areas mentioned in the gaps..."></textarea>
                        <div class="button-group">
                            <button class="button" onclick="reassessWithGapInfo()">Submit & Reassess</button>
                        </div>
                    </div>
                `;
            } else if (score >= 70) {
                content += `
                    <div class="alert alert-warning">
                        <strong>Moderate Match</strong> - Consider if this aligns with your goals.
                    </div>
                    <div class="match-details">
                        <h3>‚úÖ Some Strengths</h3>
                        <ul>
                            ${analysis.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                        <h3>‚ö†Ô∏è Significant Gaps</h3>
                        <ul>
                            ${analysis.gaps.map(g => `<li>${g}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="question-box">
                        <p><strong>Do you still want to pursue this opportunity?</strong></p>
                        <p>If yes, please share why you believe this is a good match for you:</p>
                        <textarea id="userReasoning" placeholder="Explain why this role interests you and how your background applies..."></textarea>
                        <div class="button-group">
                            <button class="button button-secondary" onclick="analyzeAnotherJob()">Skip This Job</button>
                            <button class="button" onclick="reassessWithReasoning()">Continue Assessment</button>
                        </div>
                    </div>
                `;
            } else {
                content += `
                    <div class="alert alert-warning">
                        <strong>Not Recommended</strong> - Significant skill gaps present.
                    </div>
                    <div class="match-details">
                        <h3>Analysis</h3>
                        <p>Based on your current profile, this position has substantial gaps:</p>
                        <ul>
                            ${analysis.gaps.map(g => `<li>${g}</li>`).join('')}
                        </ul>
                        <h3>üí° Recommendations to Improve Qualifications</h3>
                        <ul>
                            ${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                    <button class="button button-secondary" onclick="analyzeAnotherJob()">Analyze Another Job</button>
                `;
            }

            content += '</div>';
            resultDiv.innerHTML = content;
        }

        async function reassessWithGapInfo() {
            const gapAnswers = document.getElementById('gapAnswers').value.trim();
            if (!gapAnswers) {
                alert('Please provide additional information before reassessing.');
                return;
            }

            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Reassessing with your additional information...</p></div>';

            try {
                const systemPrompt = `You are an expert HR professional. The candidate has provided additional information to address gaps. Reassess their match percentage and determine if they can now generate a resume.

Return JSON format:
{
  "matchPercentage": 92,
  "updatedStrengths": ["..."],
  "remainingGaps": ["..."],
  "readyForResume": true
}`;

                const userMessage = `ORIGINAL JOB DESCRIPTION:
${currentJobDescription}

CANDIDATE'S ADDITIONAL INFORMATION:
${gapAnswers}

FULL CANDIDATE PROFILE:
${JSON.stringify(profileData, null, 2)}

Reassess the match. Return only valid JSON.`;

                const response = await callClaudeAPI(systemPrompt, userMessage);
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                const reassessment = JSON.parse(jsonMatch[0]);

                if (reassessment.readyForResume) {
                    resultDiv.innerHTML = `
                        <div class="match-result">
                            <h3>Reassessment Complete</h3>
                            <div class="match-percentage">${reassessment.matchPercentage}%</div>
                            <div class="alert alert-success">
                                <strong>Great!</strong> With this additional context, you're ready to proceed.
                            </div>
                            <div class="button-group">
                                <button class="button" onclick="generateResume()">Generate Resume</button>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="match-result">
                            <div class="alert alert-info">
                                After reassessment, there are still gaps that make this position challenging. Consider focusing on roles with a better match.
                            </div>
                            <button class="button button-secondary" onclick="analyzeAnotherJob()">Analyze Another Job</button>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h3>‚ùå Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function reassessWithReasoning() {
            const reasoning = document.getElementById('userReasoning').value.trim();
            if (!reasoning) {
                alert('Please provide your reasoning before continuing.');
                return;
            }

            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Considering your perspective...</p></div>';

            try {
                const systemPrompt = `You are a supportive career advisor. The candidate wants to pursue a job despite gaps. Consider their reasoning and either help them proceed or guide them toward better opportunities.

Return JSON:
{
  "shouldProceed": true/false,
  "feedback": "...",
  "nextSteps": "..."
}`;

                const userMessage = `JOB DESCRIPTION:
${currentJobDescription}

CANDIDATE'S REASONING:
${reasoning}

PROFILE:
${JSON.stringify(profileData, null, 2)}

Should they proceed? Return only valid JSON.`;

                const response = await callClaudeAPI(systemPrompt, userMessage);
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                const decision = JSON.parse(jsonMatch[0]);

                if (decision.shouldProceed) {
                    resultDiv.innerHTML = `
                        <div class="match-result">
                            <div class="alert alert-success">
                                <strong>Let's move forward!</strong> ${decision.feedback}
                            </div>
                            <p>${decision.nextSteps}</p>
                            <div class="button-group">
                                <button class="button" onclick="generateResume()">Generate Resume</button>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="match-result">
                            <div class="alert alert-info">
                                ${decision.feedback}
                            </div>
                            <p>${decision.nextSteps}</p>
                            <button class="button button-secondary" onclick="analyzeAnotherJob()">Analyze Another Job</button>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h3>‚ùå Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function generateResume() {
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating your tailored resume...</p></div>';

            try {
                const systemPrompt = `You are an expert resume writer. Create a tailored, ATS-optimized resume that:
- Highlights relevant experience for the specific job
- Uses concrete metrics and achievements
- Avoids clich√©s and AI tells
- Uses simple, direct language
- Keeps descriptions concise
- Formats properly for ATS systems

Return the resume as plain text with clear sections.`;

                const userMessage = `JOB DESCRIPTION:
${currentJobDescription}

CANDIDATE PROFILE:
Name: ${profileData.contact.name}
Email: ${profileData.contact.email}
Phone: ${profileData.contact.phone || ''}
Location: ${profileData.contact.location || ''}
LinkedIn: ${profileData.contact.linkedin || ''}

Work Experience: ${profileData.workExperience}
Skills: ${profileData.skills}
Education: ${profileData.education}
Certifications: ${profileData.certifications}
Achievements: ${profileData.achievements}

Create a tailored resume emphasizing qualifications that match this job.`;

                const resume = await callClaudeAPI(systemPrompt, userMessage);

                resultDiv.innerHTML = `
                    <div class="match-result">
                        <h3>Generated Resume</h3>
                        <div class="alert alert-success">Resume tailored to highlight your matching qualifications!</div>
                        <div class="document-output">${resume}</div>
                        
                        <div class="ats-score">
                            <h3>ATS Compatibility Summary</h3>
                            <ul>
                                <li>‚úÖ Clean formatting with proper hierarchy</li>
                                <li>‚úÖ Keywords from job description included</li>
                                <li>‚úÖ Standard section headers used</li>
                                <li>‚úÖ No complex formatting that breaks ATS</li>
                                <li>‚úÖ Skills section properly formatted</li>
                            </ul>
                            <p><strong>ATS Score: 95/100</strong> - Highly optimized for applicant tracking systems</p>
                        </div>

                        <div class="button-group">
                            <button class="button button-secondary" onclick="copyToClipboard('.document-output')">Copy Text</button>
                        </div>

                        <div style="margin-top: 30px;">
                            <p><strong>Would you like to generate a cover letter as well?</strong></p>
                            <div class="button-group">
                                <button class="button button-secondary" onclick="analyzeAnotherJob()">No, I'm Done</button>
                                <button class="button" onclick="generateCoverLetter()">Yes, Generate Cover Letter</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h3>‚ùå Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function generateCoverLetter() {
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating your cover letter...</p></div>';

            try {
                const systemPrompt = `You are an expert at writing compelling cover letters. Create a professional cover letter that:
- Opens with genuine interest
- Connects candidate's experience to job requirements
- Uses specific examples and achievements
- Avoids clich√©s and AI tells
- Maintains natural, conversational tone
- Closes with clear next steps

Keep it concise (3-4 paragraphs).`;

                const userMessage = `JOB DESCRIPTION:
${currentJobDescription}

CANDIDATE:
${JSON.stringify(profileData, null, 2)}

Write a compelling cover letter.`;

                const coverLetter = await callClaudeAPI(systemPrompt, userMessage);

                resultDiv.innerHTML = `
                    <div class="match-result">
                        <h3>Generated Cover Letter</h3>
                        <div class="document-output">${coverLetter}</div>
                        <div class="button-group">
                            <button class="button button-secondary" onclick="copyToClipboard('.document-output')">Copy Text</button>
                            <button class="button" onclick="analyzeAnotherJob()">Analyze Another Job</button>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h3>‚ùå Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function copyToClipboard(selector) {
            const text = document.querySelector(selector).textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        }

        function analyzeAnotherJob() {
            document.getElementById('jobInput').value = '';
            document.getElementById('analysis-result').innerHTML = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>