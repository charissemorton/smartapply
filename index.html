<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartApply - Your AI Job Application Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* === 1. GLASSMORPHISM & DEPTH === */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 25%, #475569 50%, #334155 75%, #1e293b 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            padding: 0;
            color: #1a1a1a;
            position: relative;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Multi-layer background depth */
        .bg-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }

        .bg-orb-1 {
            width: 900px;
            height: 900px;
            background: radial-gradient(circle, rgba(71, 85, 105, 0.4) 0%, transparent 70%);
            top: -450px;
            right: -300px;
            animation: float1 25s ease-in-out infinite;
        }

        .bg-orb-2 {
            width: 700px;
            height: 700px;
            background: radial-gradient(circle, rgba(51, 65, 85, 0.35) 0%, transparent 70%);
            bottom: -250px;
            left: -200px;
            animation: float2 30s ease-in-out infinite;
        }

        .bg-orb-3 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(100, 116, 139, 0.3) 0%, transparent 70%);
            top: 40%;
            right: 30%;
            animation: float3 35s ease-in-out infinite;
        }

        @keyframes float1 {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(60px, -60px) rotate(120deg); }
            66% { transform: translate(-40px, 40px) rotate(240deg); }
        }

        @keyframes float2 {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-50px, 50px) rotate(-120deg); }
            66% { transform: translate(40px, -40px) rotate(-240deg); }
        }

        @keyframes float3 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -30px) scale(1.15); }
        }

        /* Texture overlay */
        .texture-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(45deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(-45deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 30px 30px;
            pointer-events: none;
            z-index: 0;
        }

        /* === 10. PROFESSIONAL LAYOUTS === */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Sidebar navigation */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(40px) saturate(180%);
            border-right: 1px solid rgba(255, 255, 255, 0.18);
            padding: 32px 24px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            /* === 9. ADVANCED SHADOWS === */
            box-shadow: 
                4px 0 24px rgba(0, 0, 0, 0.06),
                2px 0 12px rgba(0, 0, 0, 0.04),
                1px 0 4px rgba(0, 0, 0, 0.02),
                inset -1px 0 0 rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 56px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            backdrop-filter: blur(20px);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            text-shadow: none;
            /* box-shadow removed per user request */
        }

        /* === 7. ADVANCED TYPOGRAPHY === */
        .logo-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
            /* text-shadow removed per user request */
        }

        /* Navigation menu */
        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        /* === 6. MICRO-INTERACTIONS === */
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
            transform: translateX(4px);
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.18);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            padding: 48px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* === 1. GLASSMORPHISM === */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* === 9. MULTI-LAYER SHADOWS === */
            box-shadow: 
                0 24px 60px rgba(0, 0, 0, 0.12),
                0 12px 30px rgba(0, 0, 0, 0.08),
                0 6px 12px rgba(0, 0, 0, 0.04),
                0 2px 4px rgba(0, 0, 0, 0.02),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            padding: 40px;
            margin-bottom: 32px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #14b8a6 0%, #06b6d4 50%, #14b8a6 100%);
            background-size: 200% 100%;
            opacity: 0;
            transition: opacity 0.4s;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .glass-card:hover {
            transform: translateY(-8px);
            box-shadow: 
                0 32px 80px rgba(20, 184, 166, 0.15),
                0 16px 40px rgba(0, 0, 0, 0.10),
                0 8px 16px rgba(0, 0, 0, 0.06),
                0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        /* === 7. ADVANCED TYPOGRAPHY === */
        .section-header {
            margin-bottom: 40px;
        }

        h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 56px;
            font-weight: 800;
            letter-spacing: -2.5px;
            line-height: 1.1;
            margin-bottom: 16px;
            /* Text gradient */
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 50%, #5eead4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradientText 6s ease infinite;
        }

        @keyframes gradientText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        h2 {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            color: #ffffff;
            margin-bottom: 24px;
        }

        h3 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 16px;
        }

        .subtitle {
            font-size: 18px;
            font-weight: 500;
            color: #cbd5e1;
            line-height: 1.6;
            letter-spacing: -0.2px;
        }

        /* === 2. PREMIUM INPUTS === */
        .form-group {
            margin-bottom: 28px;
            position: relative;
        }

        .input-wrapper {
            position: relative;
        }

        /* Floating label */
        .floating-label {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 15px;
            font-weight: 600;
            color: #9ca3af;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            background: white;
            padding: 0 8px;
        }

        input:focus ~ .floating-label,
        input:not(:placeholder-shown) ~ .floating-label,
        textarea:focus ~ .floating-label,
        textarea:not(:placeholder-shown) ~ .floating-label {
            top: 0;
            font-size: 12px;
            font-weight: 700;
            color: #14b8a6;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        input, textarea, select {
            width: 100%;
            padding: 18px 20px 18px 48px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 500;
            color: #1a1a1a;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.04),
                inset 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        input::placeholder,
        textarea::placeholder {
            color: transparent;
        }

        /* Input icons */
        .input-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #9ca3af;
            transition: color 0.3s;
            pointer-events: none;
        }

        input:focus ~ .input-icon,
        textarea:focus ~ .input-icon {
            color: #14b8a6;
        }

        /* Premium focus state */
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: transparent;
            background: #ffffff;
            box-shadow: 
                0 0 0 4px rgba(20, 184, 166, 0.12),
                0 8px 24px rgba(20, 184, 166, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.06),
                inset 0 2px 4px rgba(20, 184, 166, 0.08);
            transform: translateY(-2px);
        }

        textarea {
            min-height: 140px;
            resize: vertical;
            padding-top: 20px;
        }

        textarea ~ .floating-label {
            top: 24px;
        }

        textarea:focus ~ .floating-label,
        textarea:not(:placeholder-shown) ~ .floating-label {
            top: 0;
        }

        /* === 3. SOPHISTICATED BUTTONS === */
        .button-group {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        button {
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: -0.2px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
            color: white;
            box-shadow: 
                0 8px 24px rgba(20, 184, 166, 0.35),
                0 4px 12px rgba(20, 184, 166, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }

        .btn-primary:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 16px 40px rgba(20, 184, 166, 0.45),
                0 8px 20px rgba(20, 184, 166, 0.30),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(-2px) scale(0.98);
        }

        .btn-secondary {
            background: #ffffff;
            color: #334155;
            border: 2px solid #14b8a6;
            box-shadow: 
                0 4px 12px rgba(20, 184, 166, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.08) 0%, rgba(6, 182, 212, 0.08) 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(20, 184, 166, 0.25);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.35);
        }

        .btn-danger:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(239, 68, 68, 0.45);
        }

        /* Button loading state */
        .btn-loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === 4. DATA VISUALIZATION === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #14b8a6, #06b6d4, #14b8a6);
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.4s;
            z-index: -1;
        }

        .stat-card:hover {
            border-color: transparent;
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 50px rgba(20, 184, 166, 0.25),
                0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        /* Circular progress ring */
        .stat-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }

        .stat-ring svg {
            transform: rotate(-90deg);
        }

        .stat-ring-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 8;
        }

        .stat-ring-progress {
            fill: none;
            stroke: url(#statGradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 900;
            color: #334155;
        }

        .stat-label {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 13px;
            color: #6b7280;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 12px;
        }

        /* Animated counter */
        .counter {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 20px 0 12px;
            letter-spacing: -2px;
        }

        /* === 5. ILLUSTRATIONS / GRAPHICS === */
        .hero-illustration {
            text-align: center;
            padding: 60px 0;
            position: relative;
        }

        .hero-graphic {
            width: 200px;
            height: 200px;
            margin: 0 auto 32px;
            position: relative;
            animation: floatIllustration 6s ease-in-out infinite;
        }

        @keyframes floatIllustration {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .hero-graphic-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.25), rgba(6, 182, 212, 0.25));
            position: relative;
            box-shadow: 
                0 20px 60px rgba(20, 184, 166, 0.3),
                inset 0 -10px 30px rgba(20, 184, 166, 0.2);
        }

        .hero-graphic-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        /* Abstract decorative shapes */
        .decoration-shape {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.12), rgba(100, 116, 139, 0.12));
            animation: float 20s ease-in-out infinite;
        }

        .decoration-shape-1 {
            width: 100px;
            height: 100px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .decoration-shape-2 {
            width: 150px;
            height: 150px;
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }

        .decoration-shape-3 {
            width: 80px;
            height: 80px;
            bottom: 20%;
            left: 15%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(20px, -20px) scale(1.1); }
            66% { transform: translate(-15px, 15px) scale(0.9); }
        }

        /* === 8. COLOR SOPHISTICATION === */
        /* Success/Warning/Error system */
        .alert {
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            border-left: 6px solid;
            font-weight: 600;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
            color: #065f46;
            border-color: #10b981;
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(220, 38, 38, 0.08));
            color: #991b1b;
            border-color: #ef4444;
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(37, 99, 235, 0.08));
            color: #ffffff;
            border-color: #3b82f6;
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(217, 119, 6, 0.08));
            color: #92400e;
            border-color: #f59e0b;
        }

        /* Badge system */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }

        .badge-primary {
            background: linear-gradient(135deg, #14b8a6, #06b6d4);
            color: white;
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.35);
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.35);
        }

        /* Section visibility */
        .section {
            display: none;
            animation: fadeSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section.active {
            display: block;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, #e5e7eb 0%, #f3f4f6 50%, #e5e7eb 100%);
            background-size: 200% 100%;
            animation: skeleton 1.5s ease-in-out infinite;
            border-radius: 12px;
            height: 20px;
            margin-bottom: 12px;
        }

        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(20, 184, 166, 0.2);
            border-top-color: #14b8a6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        /* Document output */
        .document-output {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 32px;
            margin-top: 24px;
            font-family: 'Inter', monospace;
            font-size: 14px;
            line-height: 1.8;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* Custom scrollbar */
        .document-output::-webkit-scrollbar {
            width: 12px;
        }

        .document-output::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 10px;
        }

        .document-output::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #14b8a6, #06b6d4);
            border-radius: 10px;
        }

        .document-output::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0d9488, #0891b2);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                padding: 32px;
            }
        }

        @media (max-width: 968px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 24px;
            }

            .main-content {
                padding: 24px 16px;
            }

            h1 {
                font-size: 40px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        /* File upload zone */
        .file-upload-zone {
            border: 3px dashed #14b8a6;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
            cursor: pointer;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .file-upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .file-upload-zone:hover {
            border-color: #06b6d4;
            transform: scale(1.02);
            box-shadow: 0 12px 40px rgba(20, 184, 166, 0.2);
        }

        .file-upload-zone:hover::before {
            opacity: 1;
        }

        .file-upload-icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: floatIcon 3s ease-in-out infinite;
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Match badge */
        .match-badge {
            display: inline-block;
            padding: 16px 32px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 32px;
            margin: 24px 0;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            letter-spacing: -1px;
        }

        .match-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }

        .match-good {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
        }

        .match-fair {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .match-poor {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }

        /* === MODAL STYLES === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10000;
            animation: fadeIn 0.2s ease-in-out;
        }

        .modal-overlay.show {
            display: flex !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 650px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 16px 16px 0 0;
        }

        .modal-body {
            padding: 32px;
            color: #1e293b;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .modal {
                max-width: 95%;
                margin: 20px;
            }

            .modal-header,
            .modal-body {
                padding: 20px;
            }
        }
    
    </style>
</head>
<body>

    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>
    <div class="texture-overlay"></div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">

            <div class="logo">
                <div class="logo-icon">üéØ</div>
                <div class="logo-text">SmartApply</div>
            </div>

            <nav role="navigation" aria-label="Main navigation">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link active" 
                           onclick="showSection('welcome-section')" 
                           aria-current="page" 
                           aria-label="Home - Welcome page">
                            <span class="nav-icon" aria-hidden="true">üè†</span>
                            <span>Home</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" 
                           onclick="showSection('setup-section')" 
                           aria-label="Profile - Setup your profile">
                            <span class="nav-icon" aria-hidden="true">üë§</span>
                            <span>Profile</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" 
                           onclick="showSection('review-section')" 
                           aria-label="Review - Review your profile">
                            <span class="nav-icon" aria-hidden="true">‚úì</span>
                            <span>Review</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" 
                           onclick="showSection('job-analysis-section')" 
                           aria-label="Job Match - Analyze job match">
                            <span class="nav-icon" aria-hidden="true">üéØ</span>
                            <span>Job Match</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" 
                           onclick="showSection('results-section')" 
                           aria-label="Documents - View generated documents">
                            <span class="nav-icon" aria-hidden="true">üìÑ</span>
                            <span>Documents</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" 
                           onclick="showSection('generated-files-section')" 
                           aria-label="History - View file history">
                            <span class="nav-icon" aria-hidden="true">üíæ</span>
                            <span>History</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" 
                           onclick="showSection('about-section')" 
                           aria-label="About & Guidelines - View usage guidelines">
                            <span class="nav-icon" aria-hidden="true">‚ÑπÔ∏è</span>
                            <span>About & Guidelines</span>
                        </a>
                    </li>
                </ul>
            </nav>
        
        </aside>

        <!-- Main Content -->
        <main class="main-content" role="main">
            <!-- Welcome Section -->
            <div id="welcome-section" class="section active">
                <div class="section-header">
                    <h1>Find Your Perfect Role</h1>
                    <p class="subtitle">Your AI Job Application Assistant - Intelligent matching with instant resume and cover letter generation</p>
                </div>

                <div class="glass-card">
                    <div class="hero-illustration">
                        <div class="hero-graphic">
                            <div class="hero-graphic-circle">
                                <div class="hero-graphic-icon">üöÄ</div>
                            </div>
                        </div>
                        <div class="decoration-shape decoration-shape-1"></div>
                        <div class="decoration-shape decoration-shape-2"></div>
                        <div class="decoration-shape decoration-shape-3"></div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-ring">
                                <svg width="120" height="120">
                                    <defs>
                                        <linearGradient id="statGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#14b8a6"/>
                                            <stop offset="100%" style="stop-color:#06b6d4"/>
                                        </linearGradient>
                                    </defs>
                                    <circle class="stat-ring-bg" cx="60" cy="60" r="45"/>
                                    <circle class="stat-ring-progress" cx="60" cy="60" r="45" style="stroke-dashoffset: 70;"/>
                                </svg>
                                <div class="stat-ring-text">AI</div>
                            </div>
                            <div class="stat-label">Powered</div>
                        </div>

                        <div class="stat-card">
                            <div class="counter">60s</div>
                            <div class="stat-label">Average Time</div>
                        </div>

                        <div class="stat-card">
                            <div class="counter">ATS</div>
                            <div class="stat-label">Optimized</div>
                        </div>
                    </div>

                    <div class="button-group" style="justify-content: center;">
                        <button class="btn-primary" onclick="showSection('setup-section')">
                            <span>Get Started</span>
                            <span>‚Üí</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Setup Section -->
            <div id="setup-section" class="section">
                <h2>Profile Setup</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">Choose how you'd like to set up your profile:</p>
                
                <!-- Responsible Use Banner -->
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #fbbf24; border-radius: 12px; padding: 24px; margin-bottom: 32px;">
                    <div style="display: flex; align-items: start;">
                        <span style="font-size: 24px; margin-right: 12px;">‚ö†Ô∏è</span>
                        <div style="flex: 1;">
                            <h3 style="color: #78350f; font-size: 18px; font-weight: 700; margin-bottom: 16px;">Important: Responsible Use</h3>
                            
                            <p style="color: #92400e; line-height: 1.6; margin-bottom: 12px;">
                                <strong>SmartApply uses AI to help format and articulate YOUR qualifications and experience.</strong>
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0;">
                                <div>
                                    <p style="color: #059669; font-weight: 600; margin-bottom: 8px;">‚úì This tool DOES:</p>
                                    <ul style="list-style: none; color: #92400e; font-size: 14px; line-height: 1.6;">
                                        <li>‚úì Help write about your real experience</li>
                                        <li>‚úì Format information for maximum impact</li>
                                        <li>‚úì Tailor qualifications to jobs</li>
                                    </ul>
                                </div>
                                <div>
                                    <p style="color: #dc2626; font-weight: 600; margin-bottom: 8px;">‚úó This tool DOES NOT:</p>
                                    <ul style="list-style: none; color: #92400e; font-size: 14px; line-height: 1.6;">
                                        <li>‚úó Create false qualifications</li>
                                        <li>‚úó Fabricate skills you don't have</li>
                                        <li>‚úó Substitute for your achievements</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <p style="color: #92400e; font-size: 14px; font-style: italic; margin-top: 12px;">
                                You are responsible for ensuring all information is accurate, truthful, and verifiable. 
                                <a href="#" onclick="showSection('about-section'); return false;" style="color: #78350f; text-decoration: underline; font-weight: 600;">Read Full Guidelines ‚Üí</a>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Document Upload Box -->
                <div class="file-upload-zone" onclick="document.getElementById('file-input-main').click()" style="margin-bottom: 24px;">
                    <p style="font-size: 48px; margin-bottom: 16px;">üìÑ</p>
                    <p style="font-weight: 600; margin-bottom: 8px; color: #1e293b;">Upload your resume/CV</p>
                    <p style="font-size: 14px; color: #94a3b8;">Supports PDF, DOCX, or TXT files</p>
                    <input type="file" id="file-input-main" accept=".pdf,.docx,.txt" multiple style="display: none;" onchange="handleMainFileUpload(event)">
                </div>
                <div id="main-upload-status" class="hidden"></div>
                
                <div style="text-align: center; margin: 24px 0;">
                    <button class="btn-secondary" onclick="showManualEntry()">Manual Entry</button>
                    <button class="btn-secondary" onclick="skipUploadToProceed()" style="margin-left: 16px;">Skip Upload</button>
                </div>

                <!-- Manual Entry Form (Full Page) -->
                <div id="manual-entry-form" class="hidden">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="name" required>
                    </div>

                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="email" required>
                    </div>

                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone">
                    </div>

                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="location" placeholder="City, State">
                    </div>

                    <div class="form-group">
                        <label>LinkedIn Profile</label>
                        <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourname">
                    </div>

                    <div class="form-group">
                        <label>Work Experience</label>
                        <textarea id="experience" placeholder="List your relevant work experience..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Skills</label>
                        <textarea id="skills" placeholder="List your key skills..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Education</label>
                        <textarea id="education" placeholder="Your educational background..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Certifications</label>
                        <textarea id="certifications" placeholder="Any relevant certifications..."></textarea>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="showSection('setup-section'); hideManualEntry()">Back</button>
                        <button class="btn-primary" onclick="saveManualProfile()">Save Profile</button>
                    </div>
                </div>


            </div>

            <!-- Review Section -->
            <div id="review-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('setup-section')">‚Üê Back to Setup</button>
                </div>
                
                <h2>Review Your Profile</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">Please review and edit if needed:</p>
                
                <div id="profile-review"></div>
                
                <div class="button-group">
                    <button class="btn-secondary" onclick="editProfile()">Edit Profile</button>
                    <button class="btn-danger" onclick="startOver()">Start Over</button>
                    <button class="btn-primary" onclick="confirmProfile()">Confirm & Continue</button>
                </div>
            </div>

            <!-- Job Analysis Section -->
            <div id="job-analysis-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('review-section')">‚Üê Back to Profile</button>
                    <button class="btn-secondary" onclick="showGeneratedFiles()">üìÅ View Generated Files</button>
                </div>
                
                <h2>Analyze a Job Posting</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">
                    Paste the job description below. 
                    <span style="font-size: 13px; color: #999;">
                        (Note: Due to browser security restrictions, this tool cannot fetch URLs directly. 
                        Copy and paste the text instead.)
                    </span>
                </p>
                
                <div class="form-group">
                    <label>Job Description</label>
                    <textarea id="job-description" 
                              placeholder="Paste the full job description here..." 
                              style="min-height: 200px;" 
                              aria-label="Job description - Paste the job posting text here"></textarea>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="analyzeJob()">Analyze Job Match</button>
                </div>

                <div id="analysis-result" class="hidden" role="region" aria-live="polite" aria-atomic="true"></div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('job-analysis-section')">‚Üê Back to Job Analysis</button>
                    <button class="btn-secondary" onclick="showGeneratedFiles()">üìÅ View Generated Files</button>
                </div>
                
                <div id="results-content" role="region" aria-live="polite" aria-atomic="true"></div>
            </div>

            <!-- Generated Files Section -->
            <div id="generated-files-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="returnToPreviousSection()">‚Üê Back</button>
                </div>
                
                <h2>Generated Files</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">All your generated resumes and cover letters:</p>
                
                <div id="files-list" class="generated-files-list">
                    <p style="color: #cbd5e1; text-align: center;">No files generated yet.</p>
                </div>
            </div>

            <!-- About/Guidelines Section -->
            <div id="about-section" class="section">
                <h2>About SmartApply & Guidelines</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">Responsible Use Guidelines & Best Practices</p>
                
                <div style="max-width: 900px; margin: 0 auto; color: #e2e8f0;">
                    
                    <!-- What Is SmartApply -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #14b8a6; font-size: 20px; margin-bottom: 16px;">What Is SmartApply?</h3>
                        <p style="line-height: 1.7; margin-bottom: 12px;">
                            SmartApply is an AI-powered writing assistant that helps you create professional resumes and cover letters. 
                            Think of it like working with a professional resume writer or career coach‚Äîit helps you present your real 
                            qualifications in the best possible way.
                        </p>
                        <p style="line-height: 1.7;">
                            <strong style="color: #fbbf24;">Important:</strong> SmartApply is a <strong>formatting and writing tool</strong>, 
                            not a qualification creator. It helps you articulate YOUR experience, not invent experience you don't have.
                        </p>
                    </div>

                    <!-- What It Does -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #14b8a6; font-size: 20px; margin-bottom: 16px;">‚úÖ What SmartApply DOES</h3>
                        <ul style="padding-left: 24px; line-height: 1.7;">
                            <li style="margin-bottom: 8px;"><strong>Professional Formatting:</strong> Format your work experience in industry-standard layouts</li>
                            <li style="margin-bottom: 8px;"><strong>Writing Assistance:</strong> Help you articulate your accomplishments clearly and improve grammar</li>
                            <li style="margin-bottom: 8px;"><strong>Job Matching:</strong> Analyze job descriptions and highlight your relevant qualifications</li>
                            <li style="margin-bottom: 8px;"><strong>Content Optimization:</strong> Use action verbs, quantify achievements, and organize information logically</li>
                        </ul>
                    </div>

                    <!-- What It Does NOT -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #ef4444; font-size: 20px; margin-bottom: 16px;">‚ùå What SmartApply DOES NOT Do</h3>
                        <ul style="padding-left: 24px; line-height: 1.7;">
                            <li style="margin-bottom: 8px;">Does not invent work experience or fabricate skills</li>
                            <li style="margin-bottom: 8px;">Does not create fake degrees or certifications</li>
                            <li style="margin-bottom: 8px;">Does not guarantee job interviews or offers</li>
                            <li style="margin-bottom: 8px;">Does not replace your actual qualifications</li>
                        </ul>
                    </div>

                    <!-- Your Responsibilities -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #14b8a6; font-size: 20px; margin-bottom: 16px;">üë§ Your Responsibilities</h3>
                        <div style="background: rgba(20, 184, 166, 0.1); border: 2px solid #14b8a6; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                            <p style="font-weight: 600; margin-bottom: 12px;">You are responsible for:</p>
                            <ul style="padding-left: 24px; line-height: 1.7;">
                                <li style="margin-bottom: 8px;"><strong>Truthfulness:</strong> Everything on your resume must be 100% true</li>
                                <li style="margin-bottom: 8px;"><strong>Verification:</strong> You must be able to prove and demonstrate everything you claim</li>
                                <li style="margin-bottom: 8px;"><strong>Review & Editing:</strong> Always review generated documents before submitting</li>
                                <li style="margin-bottom: 8px;"><strong>Company Policies:</strong> Respect employer requirements regarding AI-generated materials</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Common Questions -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #14b8a6; font-size: 20px; margin-bottom: 16px;">ü§î Common Questions</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #cbd5e1; font-weight: 600; margin-bottom: 8px;">Q: Do I need to disclose that I used AI assistance?</h4>
                            <p style="line-height: 1.7; color: #94a3b8;">
                                <strong>Usually no.</strong> Using AI for writing/formatting is like using spell check or working with a resume writer. 
                                However, answer honestly if an application explicitly asks, or if company policies prohibit AI tools.
                            </p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #cbd5e1; font-weight: 600; margin-bottom: 8px;">Q: Is using AI writing assistance considered cheating?</h4>
                            <p style="line-height: 1.7; color: #94a3b8;">
                                <strong>No.</strong> Using writing assistance tools is standard practice, like using Microsoft Word or Grammarly. 
                                The key distinction: using tools to present your REAL qualifications = OK. Making up qualifications = NOT OK.
                            </p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #cbd5e1; font-weight: 600; margin-bottom: 8px;">Q: What if SmartApply suggests something inaccurate?</h4>
                            <p style="line-height: 1.7; color: #94a3b8;">
                                <strong>You are the final authority.</strong> If SmartApply suggests a skill you don't have or an accomplishment 
                                you didn't achieve, remove it. Always review and edit before submitting.
                            </p>
                        </div>
                    </div>

                    <!-- Privacy & Data -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #14b8a6; font-size: 20px; margin-bottom: 16px;">üîí Privacy & Data</h3>
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 20px;">
                            <ul style="list-style: none; color: #1e40af; line-height: 1.7;">
                                <li style="padding: 6px 0;">üîí Your resume and profile data are stored locally in your browser</li>
                                <li style="padding: 6px 0;">üîí AI processing uses Claude API but Anthropic does not train on your data</li>
                                <li style="padding: 6px 0;">üîí Generated documents are yours to use as you see fit</li>
                                <li style="padding: 6px 0;">üîí Delete your data anytime from your browser settings</li>
                                <li style="padding: 6px 0;">üîí We don't sell or share your personal information</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Results Disclaimer -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #14b8a6; font-size: 20px; margin-bottom: 16px;">üìã Results Disclaimer</h3>
                        <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border: 2px solid #a855f7; border-radius: 12px; padding: 20px;">
                            <p style="color: #7c3aed; line-height: 1.6; margin-bottom: 12px;">
                                SmartApply helps create professional application materials but does not guarantee job interviews or offers.
                            </p>
                            <p style="color: #7c3aed; font-weight: 600; margin-bottom: 8px;">Success depends on:</p>
                            <ul style="list-style: none; color: #7c3aed;">
                                <li>‚Ä¢ The accuracy of your profile information</li>
                                <li>‚Ä¢ Job market conditions and competition</li>
                                <li>‚Ä¢ How well your qualifications match the position</li>
                                <li>‚Ä¢ Company-specific hiring processes</li>
                                <li>‚Ä¢ The quality of your interview performance</li>
                            </ul>
                        </div>
                    </div>

                    <!-- When in Doubt -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #14b8a6; font-size: 20px; margin-bottom: 16px;">üìû When in Doubt</h3>
                        <div style="background: rgba(251, 191, 36, 0.1); border: 2px solid #fbbf24; border-radius: 8px; padding: 20px;">
                            <p style="font-weight: 600; margin-bottom: 12px;">If you're ever unsure about whether something is appropriate, ask yourself:</p>
                            <ol style="padding-left: 24px; line-height: 1.7;">
                                <li style="margin-bottom: 8px;"><strong>"Is this claim 100% true?"</strong> If yes ‚Üí include it. If no ‚Üí don't.</li>
                                <li style="margin-bottom: 8px;"><strong>"Could I prove this in an interview?"</strong> If yes ‚Üí include it. If no ‚Üí don't.</li>
                                <li style="margin-bottom: 8px;"><strong>"Would I be comfortable explaining how I achieved this?"</strong> If yes ‚Üí include it. If no ‚Üí don't.</li>
                            </ol>
                            <p style="margin-top: 16px; font-style: italic;"><strong>When in doubt, err on the side of honesty.</strong></p>
                        </div>
                    </div>

                    <!-- Bottom Line -->
                    <div style="text-align: center; padding: 32px; background: rgba(20, 184, 166, 0.1); border-radius: 12px;">
                        <p style="font-size: 18px; font-weight: 600; color: #14b8a6; margin-bottom: 8px;">
                            Using SmartApply responsibly means using it to present your real qualifications professionally‚Äînothing more, nothing less.
                        </p>
                    </div>
                </div>
            </div>

    <script>
        // ========================================
        // SECURITY & UTILITY FUNCTIONS
        // ========================================
        
        /**
         * Escapes HTML to prevent XSS attacks
         * @param {string} unsafe - Untrusted user input
         * @returns {string} Safe HTML string
         */
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            if (typeof unsafe !== 'string') unsafe = String(unsafe);
            return unsafe
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        /**
         * Input validators
         */
        const validators = {
            email: (val) => {
                if (!val) return false;
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
            },
            phone: (val) => {
                if (!val) return true; // Optional field
                return /^\+?[\d\s\-\(\)]{10,}$/.test(val);
            },
            url: (val) => {
                if (!val) return true; // Optional field
                try {
                    new URL(val.startsWith('http') ? val : 'https://' + val);
                    return true;
                } catch {
                    return false;
                }
            },
            required: (val) => {
                return val && val.trim().length > 0;
            }
        };

        /**
         * API rate limiter to prevent abuse
         */
        const rateLimiter = {
            calls: [],
            MAX_PER_HOUR: 50,
            
            canCall() {
                const oneHourAgo = Date.now() - (60 * 60 * 1000);
                this.calls = this.calls.filter(t => t > oneHourAgo);
                return this.calls.length < this.MAX_PER_HOUR;
            },
            
            recordCall() {
                this.calls.push(Date.now());
            },
            
            getRemainingCalls() {
                const oneHourAgo = Date.now() - (60 * 60 * 1000);
                this.calls = this.calls.filter(t => t > oneHourAgo);
                return this.MAX_PER_HOUR - this.calls.length;
            }
        };

        /**
         * Centralized error handler
         */
        function handleError(error, context, userMessage = 'An error occurred. Please try again.') {
            console.error(`Error in ${context}:`, error);
            
            // Log technical details
            if (error.stack) {
                console.error('Stack trace:', error.stack);
            }
            
            // Return user-friendly message
            return {
                message: userMessage,
                technicalDetails: error.message,
                context: context
            };
        }

        // ========================================
        // STORAGE FUNCTIONS
        // ========================================
        
        // Storage wrapper functions that work whether storage API is available or not
        async function safeStorageGet(key) {
            try {
                if (typeof window.storage !== 'undefined' && window.storage) {
                    return await window.storage.get(key);
                }
                // Fallback to localStorage
                const value = localStorage.getItem(key);
                return value ? { value: value } : null;
            } catch (error) {
                console.log('Storage get failed, using memory only:', error);
                return null;
            }
        }

        async function safeStorageSet(key, value) {
            try {
                if (typeof window.storage !== 'undefined' && window.storage) {
                    await window.storage.set(key, value);
                } else {
                    // Fallback to localStorage
                    localStorage.setItem(key, value);
                }
            } catch (error) {
                console.log('Storage set failed, continuing without persistence:', error);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        function stripMarkdownCodeFences(text) {
            // Remove ```json or ``` code fences that Claude sometimes adds
            return text
                .replace(/^```json\s*/i, '')
                .replace(/^```\s*/, '')
                .replace(/\s*```$/, '')
                .trim();
        }

        async function callClaudeAPI(systemPrompt, userMessage) {
            // Check rate limit
            if (!rateLimiter.canCall()) {
                throw new Error(`Rate limit exceeded. You can make ${rateLimiter.MAX_PER_HOUR} requests per hour. Please try again later.`);
            }
            
            const netlifyFunctionUrl = 'https://curious-rugelach-e5ffb8.netlify.app/.netlify/functions/claude-proxy';
            
            console.log('=== CALLING CLAUDE API ===');
            console.log('System prompt length:', systemPrompt.length);
            console.log('User message length:', userMessage.length);
            console.log('Total payload size (approx):', (systemPrompt.length + userMessage.length));
            console.log('Remaining API calls this hour:', rateLimiter.getRemainingCalls());
            
            // Create abort controller for timeout
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 45000); // 45 second timeout
            
            try {
                const response = await fetch(netlifyFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        systemPrompt: systemPrompt,
                        userMessage: userMessage,
                        maxTokens: 4000,
                        temperature: 0
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeout);

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    // Get more details about the error
                    let errorDetails = '';
                    try {
                        const errorData = await response.json();
                        errorDetails = JSON.stringify(errorData);
                        console.error('Error response body:', errorData);
                    } catch (e) {
                        errorDetails = await response.text();
                        console.error('Error response text:', errorDetails);
                    }
                    throw new Error(`API call failed: ${response.status} ${response.statusText} - ${errorDetails}`);
                }

                // Record successful call for rate limiting
                rateLimiter.recordCall();

                const data = await response.json();
                const rawText = data.content[0].text;
                return stripMarkdownCodeFences(rawText);
            } catch (error) {
                clearTimeout(timeout);
                
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out after 45 seconds. Please try again.');
                }
                throw error;
            }
        }





        async function safeStorageDelete(key) {
            try {
                if (typeof window.storage !== 'undefined' && window.storage) {
                    await window.storage.delete(key);
                } else {
                    localStorage.removeItem(key);
                }
            } catch (error) {
                console.log('Storage delete failed:', error);
            }
        }

        // Initialize storage
        // APPLICATION STATE NAMESPACE
        // All global state wrapped in single object to prevent naming collisions
        const AppState = {
            profile: null,
            currentJob: null,
            analysis: null,
            resumeText: null,
            coverLetterText: null,
            resumeATS: null,
            coverLetterATS: null,
            previousSection: null,
            files: [],
            ocrCancelled: false,
            
            // Reset all state (useful for starting over)
            reset() {
                this.profile = null;
                this.currentJob = null;
                this.analysis = null;
                this.resumeText = null;
                this.coverLetterText = null;
                this.resumeATS = null;
                this.coverLetterATS = null;
                this.previousSection = null;
                this.files = [];
                this.ocrCancelled = false;
            }
        };
        
        // Legacy aliases for backwards compatibility (will remove gradually)
        let profileData = AppState.profile;
        let currentJobDescription = AppState.currentJob;
        let currentAnalysis = AppState.analysis;
        let currentResumeText = AppState.resumeText;
        let currentCoverLetterText = AppState.coverLetterText;
        let currentResumeATS = AppState.resumeATS;
        let currentCoverLetterATS = AppState.coverLetterATS;
        let previousSection = AppState.previousSection;
        let generatedFiles = AppState.files;
        let ocrCancelled = AppState.ocrCancelled;

        // Load saved data
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load profile
                const savedProfile = await safeStorageGet('job-assistant-profile');
                if (savedProfile) {
                    profileData = JSON.parse(savedProfile.value);
                    showSection('job-analysis-section');
                }

                // Load generated files
                const savedFiles = await safeStorageGet('job-assistant-files');
                if (savedFiles) {
                    generatedFiles = JSON.parse(savedFiles.value);
                }
            } catch (error) {
                console.log('No saved data found');
            }
        });

        // Save generated files to storage
        async function saveGeneratedFiles() {
            try {
                await safeStorageSet('job-assistant-files', JSON.stringify(generatedFiles));
            } catch (error) {
                console.error('Error saving files:', error);
            }
        }

        // Add file to generated files list
        function addGeneratedFile(type, jobTitle, content) {
            const file = {
                id: Date.now(),
                type: type, // 'resume' or 'coverLetter'
                jobTitle: jobTitle,
                content: content,
                timestamp: new Date().toISOString(),
                dateStr: new Date().toLocaleString()
            };
            
            generatedFiles.unshift(file); // Add to beginning of array
            saveGeneratedFiles();
        }

        // Display generated files
        function displayGeneratedFiles() {
            const filesList = document.getElementById('files-list');
            
            if (generatedFiles.length === 0) {
                filesList.innerHTML = '<p style="color: #cbd5e1; text-align: center;">No files generated yet.</p>';
                return;
            }

            filesList.innerHTML = generatedFiles.map(file => `
                <div class="generated-file-item">
                    <div class="file-info">
                        <div class="file-name">
                            ${file.type === 'resume' ? 'üìÑ' : '‚úâÔ∏è'} 
                            ${file.type === 'resume' ? 'Resume' : 'Cover Letter'} - ${escapeHtml(file.jobTitle)}
                        </div>
                        <div class="file-meta">Generated on ${file.dateStr}</div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-secondary" onclick="viewFile(${file.id})">View</button>
                        <button class="btn-secondary" onclick="downloadFileAsDOCX(${file.id})">Download DOCX</button>
                        <button class="btn-danger" onclick="deleteFile(${file.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function viewFile(fileId) {
            const file = generatedFiles.find(f => f.id === fileId);
            if (!file) return;

            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = `
                <h3>${file.type === 'resume' ? 'Resume' : 'Cover Letter'} - ${escapeHtml(file.jobTitle)}</h3>
                <div class="document-output" style="white-space: pre-wrap;">${escapeHtml(file.content)}</div>
                <div class="button-group" style="margin-top: 24px;">
                    <button class="btn-secondary" onclick="copyToClipboard(\`${file.content.replace(/[`]/g, '\\`')}\`)">Copy Text</button>
                    <button class="btn-primary" onclick="downloadFileAsDOCX(${file.id})">Download as DOCX</button>
                </div>
            `;
            
            showSection('results-section');
        }

        function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                generatedFiles = generatedFiles.filter(f => f.id !== fileId);
                saveGeneratedFiles();
                displayGeneratedFiles();
            }
        }

        async function downloadFileAsDOCX(fileId) {
            const file = generatedFiles.find(f => f.id === fileId);
            if (!file) return;

            try {
                if (typeof JSZip === 'undefined') {
                    throw new Error('Required library not loaded. Please refresh the page.');
                }

                const zip = new JSZip();
                
                zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);
                
                zip.folder('_rels').file('.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
                
                const wordFolder = zip.folder('word');
                wordFolder.folder('_rels').file('document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`);
                
                let xmlParagraphs;
                if (file.type === 'coverLetter') {
                    const textParagraphs = file.content.split('\n\n').filter(p => p.trim() && !/^[-*_]{3,}$/.test(p.trim()));
                    xmlParagraphs = textParagraphs.map(para => {
                        const trimmed = para.trim();
                        
                        const parts = [];
                        const boldRegex = /\*\*(.+?)\*\*/g;
                        let lastIndex = 0;
                        let match;
                        
                        while ((match = boldRegex.exec(trimmed)) !== null) {
                            if (match.index > lastIndex) {
                                const beforeText = trimmed.substring(lastIndex, match.index);
                                if (beforeText) parts.push({ text: beforeText, bold: false });
                            }
                            parts.push({ text: match[1], bold: true });
                            lastIndex = match.index + match[0].length;
                        }
                        
                        if (lastIndex < trimmed.length) {
                            const remainingText = trimmed.substring(lastIndex);
                            if (remainingText) parts.push({ text: remainingText, bold: false });
                        }
                        
                        if (parts.length === 0) {
                            parts.push({ text: trimmed, bold: false });
                        }
                        
                        const runs = parts.map(part => {
                            const escaped = part.text
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&apos;');
                            
                            return `<w:r><w:rPr><w:sz w:val="22"/>${part.bold ? '<w:b/>' : ''}</w:rPr><w:t xml:space="preserve">${escaped}</w:t></w:r>`;
                        }).join('');
                        
                        return `<w:p><w:pPr><w:spacing w:after="240"/></w:pPr>${runs}</w:p>`;
                    }).join('');
                } else {
                    const HEADER_SPACING_BEFORE = 120;
                    const JOB_SECTION_SPACING_AFTER = 80;
                    
                    const lines = file.content.split('\n').filter(l => {
                        const t = l.trim();
                        return t && !/^[-*_]{3,}$/.test(t);
                    });
                    
                    xmlParagraphs = lines.map((line, index) => {
                        let trimmed = line.trim();
                        
                        const headerMatch = trimmed.match(/^(#{1,6})\s+(.+)$/);
                        let headerLevel = 0;
                        if (headerMatch) {
                            headerLevel = headerMatch[1].length;
                            trimmed = headerMatch[2];
                        }
                        
                        const cleanLine = trimmed.replace(/\*\*/g, '');
                        const isAllCaps = cleanLine === cleanLine.toUpperCase() && cleanLine.length > 2;
                        const isHeader = headerLevel > 0 || isAllCaps;
                        
                        const isBullet = /^[-‚Ä¢]\s/.test(trimmed);
                        
                        let isLastBulletInSection = false;
                        if (isBullet && index < lines.length - 1) {
                            const nextLine = lines[index + 1].trim();
                            const nextIsBullet = /^[-‚Ä¢]\s/.test(nextLine);
                            if (!nextIsBullet) {
                                const hasBold = /\*\*/.test(nextLine);
                                if (hasBold) {
                                    isLastBulletInSection = true;
                                }
                            }
                        }
                        
                        const parts = [];
                        const boldRegex = /\*\*(.+?)\*\*/g;
                        let lastIndex = 0;
                        let match;
                        
                        while ((match = boldRegex.exec(trimmed)) !== null) {
                            if (match.index > lastIndex) {
                                const beforeText = trimmed.substring(lastIndex, match.index);
                                if (beforeText) parts.push({ text: beforeText, bold: isHeader });
                            }
                            parts.push({ text: match[1], bold: true });
                            lastIndex = match.index + match[0].length;
                        }
                        
                        if (lastIndex < trimmed.length) {
                            const remainingText = trimmed.substring(lastIndex);
                            if (remainingText) parts.push({ text: remainingText, bold: isHeader });
                        }
                        
                        if (parts.length === 0) {
                            parts.push({ text: trimmed, bold: isHeader });
                        }
                        
                        const runs = parts.map(part => {
                            const escaped = part.text
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&apos;');
                            
                            const fontSize = isHeader ? 28 : 22;
                            const isBold = part.bold;
                            
                            return `<w:r><w:rPr><w:sz w:val="${fontSize}"/>${isBold ? '<w:b/>' : ''}</w:rPr><w:t xml:space="preserve">${escaped}</w:t></w:r>`;
                        }).join('');
                        
                        let spacingAfter = 0;
                        if (isLastBulletInSection) {
                            spacingAfter = JOB_SECTION_SPACING_AFTER;
                        }
                        const spacingBefore = isHeader ? HEADER_SPACING_BEFORE : 0;
                        
                        return `<w:p><w:pPr><w:spacing w:after="${spacingAfter}" w:before="${spacingBefore}"/></w:pPr>${runs}</w:p>`;
                    }).join('');
                }
                
                wordFolder.file('document.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    ${xmlParagraphs}
  </w:body>
</w:document>`);
                
                const blob = await zip.generateAsync({type: 'blob'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${file.jobTitle.replace(/[^a-z0-9]/gi, '_')}_${file.type}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error creating DOCX:', error);
                alert('Error creating DOCX file. You can use the Copy Text button instead.');
            }
        }

        function showGeneratedFiles() {
            previousSection = document.querySelector('.section.active').id;
            displayGeneratedFiles();
            showSection('generated-files-section');
        }

        function returnToPreviousSection() {
            if (previousSection) {
                showSection(previousSection);
            } else {
                showSection('job-analysis-section');
            }
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target section
            document.getElementById(sectionId).classList.add('active');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                // Add active to matching link
                const linkSection = link.getAttribute('onclick');
                if (linkSection && linkSection.includes(sectionId)) {
                    link.classList.add('active');
                }
            });
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // New function: Only clear when explicitly starting a new job analysis
        function startNewJobAnalysis() {
            // Clear the job description
            const jobDescTextarea = document.getElementById('job-description');
            if (jobDescTextarea) {
                jobDescTextarea.value = '';
            }
            
            // Clear the match analysis display
            const analysisResult = document.getElementById('analysis-result');
            if (analysisResult) {
                analysisResult.innerHTML = '';
                analysisResult.classList.add('hidden');
            }
            
            // Clear previous results
            const resultsContent = document.getElementById('results-content');
            if (resultsContent) {
                resultsContent.innerHTML = '';
            }
            
            // Reset stored analysis data
            currentAnalysis = null;
            currentJobDescription = null;
            
            // Navigate to job analysis
            showSection('job-analysis-section');
        }

        // Handle main file upload from setup page
        async function handleMainFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const statusDiv = document.getElementById('main-upload-status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<p style="color: #14b8a6; font-weight: 600;">Processing documents...</p>';
            
            try {
                for (const file of files) {
                    await processUploadedFile(file);
                }
                
                statusDiv.innerHTML = '<p style="color: #10b981; font-weight: 600;">‚úì Documents processed successfully!</p>';
                
                // Auto-navigate to review after successful upload
                setTimeout(() => {
                    displayProfileForReview();
                    showSection('review-section');
                }, 1000);
                
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.innerHTML = '<p style="color: #ef4444; font-weight: 600;">Error processing documents. Please try again.</p>';
            }
        }

        // Skip upload and go to manual entry or proceed with blank
        function skipUploadToProceed() {
            // Check if profile exists and has any data
            const hasData = profileData && (
                profileData.contact?.name || 
                profileData.contact?.email || 
                profileData.experience ||
                profileData.skills
            );
            
            if (!hasData) {
                alert('Please upload a document or manually enter your profile information first.');
                return;
            }
            
            // Has data, proceed to review
            displayProfileForReview();
            showSection('review-section');
        }

        // Show manual entry form
        function showManualEntry() {
            // Hide setup page, show manual entry form
            document.getElementById('manual-entry-form').classList.remove('hidden');
            document.getElementById('setup-section').style.display = 'none';
        }


        // Show location opt-in before document generation
        function showLocationOptIn() {
            const locationDiv = document.getElementById('location-optin');
            const displayLocation = document.getElementById('display-location');
            
            if (profileData.location) {
                displayLocation.textContent = profileData.location;
                locationDiv.classList.remove('hidden');
            } else {
                locationDiv.classList.add('hidden');
            }
        }

        // Get location setting for document generation
        function shouldIncludeLocation() {
            const checkbox = document.getElementById('include-location');
            return checkbox && checkbox.checked && profileData.location;
        }

        function hideManualEntry() {
            document.getElementById('manual-entry-form').classList.add('hidden');
            document.getElementById('setup-section').style.display = 'block';
        }

        function hideDocumentUpload() {
            // Document upload is inline in setup section, nothing to hide
            // This function exists to prevent errors when called from startOver()
        }


        async function saveManualProfile() {
            // Get values
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const location = document.getElementById('location').value;
            const linkedin = document.getElementById('linkedin').value;
            const experience = document.getElementById('experience').value;
            const skills = document.getElementById('skills').value;
            const education = document.getElementById('education').value;
            const certifications = document.getElementById('certifications').value;
            
            // Validate required fields
            if (!validators.required(name)) {
                alert('Name is required');
                return;
            }
            
            if (!validators.required(email)) {
                alert('Email is required');
                return;
            }
            
            if (!validators.email(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            if (phone && !validators.phone(phone)) {
                alert('Please enter a valid phone number');
                return;
            }
            
            if (linkedin && !validators.url(linkedin)) {
                alert('Please enter a valid LinkedIn URL');
                return;
            }
            
            profileData = {
                metadata: { version: "2.0" },
                name: name,
                email: email,
                phone: phone,
                location: location,
                linkedin: linkedin,
                experience: experience,
                skills: skills,
                education: education,
                certifications: certifications,
                projects: ''
            };

            // Save to storage
            try {
                await safeStorageSet('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile. Please try again.');
                return;
            }

            displayProfileForReview();
            showSection('review-section');
        }


        async function processUploadedFile(file) {
            let extractedText = '';
            
            if (file.type === 'application/pdf') {
                extractedText = await extractTextFromPDF(file);
            } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                extractedText = await extractTextFromDOCX(file);
            } else if (file.type === 'text/plain') {
                extractedText = await file.text();
            } else {
                throw new Error('Unsupported file type. Please upload PDF, DOCX, or TXT files.');
            }
            
            // Parse the extracted text
            await parseExtractedText(extractedText);
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            const statusDiv = document.getElementById('upload-status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing documents...</p></div>';

            let extractedText = '';

            for (let file of files) {
                try {
                    let text = '';
                    if (file.type === 'application/pdf') {
                        text = await extractTextFromPDF(file);
                    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        text = await extractTextFromDOCX(file);
                    } else if (file.type === 'text/plain') {
                        text = await file.text();
                    }
                    extractedText += text + '\n\n';
                } catch (error) {
                    console.error('Error processing file:', error);
                }
            }

            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing with AI...</p></div>';

            await parseExtractedText(extractedText);
            displayProfileForReview();
            
            statusDiv.innerHTML = '<div class="alert alert-success">Documents processed successfully!</div>';
            setTimeout(() => {
                showSection('review-section');
            }, 1500);
        }

        function cancelOCR() {
            ocrCancelled = true;
            console.log('OCR cancellation requested by user');
            
            const statusDiv = document.getElementById('main-upload-status');
            if (statusDiv) {
                statusDiv.innerHTML = '<p style="color: #f59e0b; font-weight: 600;">‚ö†Ô∏è OCR cancelled. Please upload a different file or use manual entry.</p>';
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
            
            try {
                const pdf = await loadingTask.promise;
                let text = '';
                let needsOCR = false;
                
                // First pass: Try normal text extraction
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const pageText = content.items.map(item => item.str).join(' ');
                    text += pageText + '\n';
                }
                
                // Check if we got meaningful text (at least 50 chars per page on average)
                const avgCharsPerPage = text.length / pdf.numPages;
                if (avgCharsPerPage < 50) {
                    console.log('PDF appears to be image-based (avg chars per page:', avgCharsPerPage, '). Using OCR...');
                    needsOCR = true;
                }
                
                // If text extraction failed, use OCR
                if (needsOCR) {
                    text = ''; // Reset text
                    ocrCancelled = false; // Reset cancellation flag
                    
                    // Show OCR progress to user with CANCEL button
                    const statusDiv = document.getElementById('main-upload-status');
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <p style="color: #14b8a6; font-weight: 600;">üìÑ Detecting image-based PDF. Running OCR... This may take 10-30 seconds.</p>
                            <button onclick="cancelOCR()" class="btn-danger" style="margin-top: 12px;">Cancel OCR</button>
                        `;
                    }
                    
                    // Process each page with OCR
                    for (let i = 1; i <= pdf.numPages; i++) {
                        // Check if user cancelled
                        if (ocrCancelled) {
                            console.log('OCR cancelled by user at page', i);
                            throw new Error('OCR cancelled by user');
                        }
                        
                        // Update progress
                        if (statusDiv) {
                            statusDiv.innerHTML = `
                                <p style="color: #14b8a6; font-weight: 600;">üìÑ Running OCR on page ${i} of ${pdf.numPages}...</p>
                                <button onclick="cancelOCR()" class="btn-danger" style="margin-top: 12px;">Cancel OCR</button>
                            `;
                        }
                        
                        const page = await pdf.getPage(i);
                        
                        // Render page to canvas
                        const viewport = page.getViewport({ scale: 2.0 }); // Higher scale for better OCR
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                        
                        // Run OCR on canvas
                        try {
                            const result = await Tesseract.recognize(canvas, 'eng', {
                                logger: m => {
                                    if (m.status === 'recognizing text') {
                                        console.log(`OCR Progress Page ${i}: ${Math.round(m.progress * 100)}%`);
                                    }
                                }
                            });
                            
                            text += result.data.text + '\n\n';
                            console.log(`OCR completed for page ${i}, extracted ${result.data.text.length} characters`);
                        } catch (ocrError) {
                            console.error(`OCR failed for page ${i}:`, ocrError);
                            // Continue with other pages even if one fails
                        }
                    }
                    
                    console.log('OCR complete. Total extracted text length:', text.length);
                    
                    // Update status
                    if (statusDiv) {
                        statusDiv.innerHTML = '<p style="color: #10b981; font-weight: 600;">‚úì OCR completed successfully!</p>';
                    }
                }
                
                return text;
            } finally {
                // Clean up PDF.js worker to prevent memory leaks
                loadingTask.destroy();
            }
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        async function parseExtractedText(text) {
            // Validate extracted text (lower threshold since OCR might have some noise)
            if (!text || text.trim().length < 50) {
                console.error('Extracted text is empty or too short:', text.length);
                throw new Error('Could not extract meaningful text from document. Please try a different file or use manual entry.');
            }
            
            console.log('Extracted text length:', text.length);
            console.log('First 300 characters:', text.substring(0, 300));
            
            // Try AI parsing first if backend is available
            let aiParsed = false;
            
            try {
                const systemPrompt = `Parse resume(s) into JSON. If multiple resumes, merge intelligently - prefer more detail.

Return ONLY this JSON (no markdown, no fences):
{
  "metadata": {"version": "2.0"},
  "name": "",
  "email": "",
  "phone": "",
  "location": "",
  "linkedin": "",
  "experience": "",
  "skills": "",
  "education": "",
  "certifications": "",
  "projects": ""
}

EXTRACTION RULES:
- Parse name, email, phone, location (city/state), complete LinkedIn URL
- Experience: Extract all work history with achievements - preserve complete text with metrics
- Skills: List all skills mentioned
- Education: Extract degrees and formal education only
- Certifications: Extract ALL certifications from any section (look for both EDUCATION and CERTIFICATIONS sections)
- Projects: Extract any technical projects, side projects, or portfolio items mentioned
- Dates: Keep original format from resume
- Multiple resumes: Use most detailed version, merge intelligently

Return ONLY the JSON.`;

                let response = await callClaudeAPI(systemPrompt, text);
                
                console.log('=== AI PARSING DEBUG ===');
                console.log('Response length:', response.length);
                console.log('Response preview:', response.substring(0, 200));
                console.log('Has JSON fences:', response.includes('```json'));
                console.log('Has code fences:', response.includes('```'));
                
                // Strip markdown code fences if present
                response = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                console.log('After fence removal:', response.substring(0, 200));
                
                profileData = JSON.parse(response);
                
                console.log('Parsing successful!');
                console.log('Profile version:', profileData.metadata?.version);
                console.log('Experience type:', Array.isArray(profileData.experience) ? 'array' : typeof profileData.experience);
                console.log('=== END DEBUG ===');
                
                aiParsed = true;
                
                // Save to storage
                await safeStorageSet('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('=== AI PARSING FAILED ===');
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                console.error('Full error:', error);
                if (error instanceof SyntaxError) {
                    console.error('This is a JSON parsing error - the AI returned invalid JSON');
                }
                console.error('=== END ERROR ===');
                console.log('Falling back to pattern-based parsing...');
                
                // Use smart pattern-based parsing instead
                profileData = parseResumeWithPatterns(text);
                
                // Save to storage
                try {
                    await safeStorageSet('job-assistant-profile', JSON.stringify(profileData));
                } catch (e) {
                    console.error('Storage error:', e);
                }
            }
        }

        function parseResumeWithPatterns(text) {
            // INPUT VALIDATION
            // Validate that text is a string
            if (!text || typeof text !== 'string') {
                console.error('Invalid input to parseResumeWithPatterns:', typeof text, 'Length:', text?.length);
                return {
                    metadata: { version: "2.0" },
                    name: '', email: '', phone: '', location: '', linkedin: '',
                    experience: '', skills: '', education: '', certifications: '', projects: ''
                };
            }
            
            // Limit text length to prevent regex DOS attacks
            if (text.length > 100000) {
                console.warn('Text too long for pattern parsing (' + text.length + ' chars), truncating to 100,000');
                text = text.substring(0, 100000);
            }
            
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            const result = {
                metadata: { version: "2.0" },
                name: '',
                email: '',
                phone: '',
                location: '',
                linkedin: '',
                experience: '',
                skills: '',
                education: '',
                certifications: '',
                projects: ''
            };
            
            // Extract contact info
            const emailMatch = text.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            if (emailMatch) result.email = emailMatch[0];
            
            const phoneMatch = text.match(/(\+?\d{1}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/);
            if (phoneMatch) result.phone = phoneMatch[0];
            
            // LinkedIn - find linkedin.com anywhere and capture full URL
            const linkedinMatch = text.match(/\S*linkedin\.com\S*/i);
            if (linkedinMatch) {
                let url = linkedinMatch[0];
                
                // Clean up trailing punctuation (from sentences)
                url = url.replace(/[,;.\)]+$/, '');
                
                // Remove leading punctuation if any
                url = url.replace(/^[\(]+/, '');
                
                // Add https:// if missing
                if (!url.startsWith('http')) {
                    url = 'https://' + url;
                }
                
                result.linkedin = url;
            }
            
            // Extract location (city, state pattern)
            const locationMatch = text.match(/([A-Z][a-z]+(?:\s[A-Z][a-z]+)*),\s*([A-Z]{2})\b/);
            if (locationMatch) result.location = locationMatch[0];
            
            // Name is typically in first few lines before contact info
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i];
                if (!line.match(/@|linkedin|http|[0-9]{3}/i) && line.length > 5 && line.length < 50) {
                    // Likely a name
                    const words = line.split(/\s+/);
                    if (words.length >= 2 && words.length <= 4) {
                        result.name = line;
                        break;
                    }
                }
            }
            
            // Find section markers
            const sections = {
                experience: [],
                skills: [],
                education: [],
                certifications: [],
                projects: []
            };
            
            let currentSection = null;
            const experienceKeywords = /experience|employment|work history|professional background|career|positions?|work experience|professional experience|career history|professional summary|employment history/i;
            const skillsKeywords = /skills|competencies|technical skills|core competencies|proficiencies|expertise|technical proficiencies|qualifications|capabilities|technologies|technical expertise/i;
            const educationKeywords = /education|academic|degrees?|university|college|school|academic background/i;
            const certificationKeywords = /certifications?|licenses?|credentials?|professional development|training|certifications & licenses/i;
            const projectKeywords = /projects?|portfolio|personal projects?|side projects?|selected projects/i;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const upperLine = line.toUpperCase();
                
                // Check if this line is a section header
                if (experienceKeywords.test(line)) {
                    currentSection = 'experience';
                    continue;
                } else if (skillsKeywords.test(line)) {
                    currentSection = 'skills';
                    continue;
                } else if (educationKeywords.test(line)) {
                    currentSection = 'education';
                    continue;
                } else if (certificationKeywords.test(line)) {
                    currentSection = 'certifications';
                    continue;
                } else if (projectKeywords.test(line)) {
                    currentSection = 'projects';
                    continue;
                }
                
                // Add content to current section
                if (currentSection && !line.match(/@|linkedin\.com|^\d{3}/i)) {
                    sections[currentSection].push(line);
                }
            }
            
            // If no sections were found, try to infer from content
            if (!sections.experience.length && !sections.skills.length && 
                !sections.education.length && !sections.certifications.length && !sections.projects.length) {
                
                // Put most content in experience, try to extract education/skills/certs
                let allText = lines.join('\n');
                
                // ATS-style education extraction: Look for degree + institution patterns
                // Pattern: Degree name + Institution keywords + optional year
                const educationPattern = /(Bachelors?|Masters?|PhD|Ph\.?D\.?|Doctorate|Associate|Doctor of|A\.?S\.?|B\.?S\.?|M\.?S\.?|MBA|M\.?B\.?A\.?|B\.?A\.?|M\.?A\.?)[\w\s,:]+(University|College|Institute|School|Tech|Polytechnic|Academy)[\w\s,:]*(19\d{2}|20\d{2})?/gi;
                const educationMatches = allText.match(educationPattern);
                
                if (educationMatches) {
                    result.education = educationMatches.join('\n');
                    // Remove from allText to avoid duplication in experience
                    educationMatches.forEach(edu => {
                        allText = allText.replace(edu, '');
                    });
                }
                
                // ATS-style certification extraction: Section-aware approach
                
                // STEP 1: Try to find certification section by header
                const certSectionPattern = /(CERTIFICATIONS?|LICENSES?|CREDENTIALS?|PROFESSIONAL DEVELOPMENT|CERTIFICATES?|TRAINING)[\s\S]*?(?=\n\n[A-Z]{3,}|\n\n\n|$)/i;
                const certSectionMatch = allText.match(certSectionPattern);
                
                if (certSectionMatch) {
                    // HIGH CONFIDENCE: Found certification section, extract everything from it
                    let certSection = certSectionMatch[0];
                    
                    // Remove the section header itself
                    certSection = certSection.replace(/^(CERTIFICATIONS?|LICENSES?|CREDENTIALS?|PROFESSIONAL DEVELOPMENT|CERTIFICATES?|TRAINING)\s*/i, '');
                    
                    // Split into lines and clean up
                    const certLines = certSection.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 3); // Remove empty/short lines
                    
                    result.certifications = certLines.join('\n');
                    
                    // Remove certification section from allText
                    allText = allText.replace(certSectionMatch[0], '');
                    
                } else {
                    // LOW CONFIDENCE: No section found, scan with STRICT rules
                    
                    // Known certification providers/vendors
                    const certProviders = /Google|IBM|Microsoft|AWS|Amazon Web Services|Azure|Oracle|SAP|Salesforce|Adobe|Red Hat|VMware|Cisco|CompTIA|Linux Foundation|Coursera|edX|Udacity|LinkedIn Learning|Pluralsight|Udemy|Harvard|MIT|Stanford|Berkeley|Yale|PMI|Project Management Institute|SHRM|CFA Institute|AICPA|Six Sigma|Scrum|Agile|ITIL/gi;
                    
                    // Certification context words
                    const certContext = /certified|certification|certificate|credential|license|licensed|issued by|awarded by|granted by|completed|earned|achieved|professional development|continuing education|course completion|training program|completion certificate|digital badge|accredited|accreditation/gi;
                    
                    const certLines = new Set();
                    const textLines = allText.split('\n');
                    
                    for (let line of textLines) {
                        // Skip short lines and contact info
                        if (line.trim().length < 10 || line.match(/@|^\(?\d{3}\)?[-.\s]/)) continue;
                        
                        const hasVendor = certProviders.test(line);
                        const hasContext = certContext.test(line);
                        const hasYear = /19\d{2}|20\d{2}/.test(line);
                        
                        // Require MULTIPLE signals to avoid false positives
                        if ((hasVendor && hasContext) || 
                            (hasContext && hasYear) || 
                            (hasVendor && line.match(/certified|certificate|credential/i))) {
                            certLines.add(line.trim());
                            // Remove from allText
                            allText = allText.replace(line, '');
                        }
                    }
                    
                    if (certLines.size > 0) {
                        result.certifications = Array.from(certLines).join('\n');
                    }
                }
                
                // Everything else goes to experience
                result.experience = allText.trim();
            } else {
                // Join sections with proper spacing and formatting
                result.experience = sections.experience.join('\n\n');
                result.skills = sections.skills.join('\n');
                result.education = sections.education.join('\n\n');
                result.certifications = sections.certifications.join('\n');
                result.projects = sections.projects.join('\n\n');
            }
            
            // Clean up: remove multiple consecutive spaces
            result.experience = result.experience.replace(/  +/g, ' ').trim();
            result.skills = result.skills.replace(/  +/g, ' ').trim();
            result.education = result.education.replace(/  +/g, ' ').trim();
            result.certifications = result.certifications.replace(/  +/g, ' ').trim();
            result.projects = result.projects.replace(/  +/g, ' ').trim();
            
            console.log('=== FALLBACK PARSER OUTPUT ===');
            console.log('Name:', result.name);
            console.log('Email:', result.email);
            console.log('Experience length:', result.experience.length);
            console.log('Skills length:', result.skills.length);
            console.log('Education length:', result.education.length);
            console.log('Certifications length:', result.certifications.length);
            console.log('Projects length:', result.projects.length);
            console.log('=== END FALLBACK OUTPUT ===');
            
            return result;
        }

        // PROFILE FORMAT MIGRATION
        // Converts old nested format (v1.0) to new flat format (v2.0)
        function migrateProfileToV2(profile) {
            // Return null if no profile
            if (!profile) return null;
            
            // Already v2.0 - return as-is
            if (profile.metadata?.version === "2.0") {
                return profile;
            }
            
            // Migrate from old nested format (v1.0)
            if (profile.contact) {
                console.log('Migrating profile from v1.0 (nested) to v2.0 (flat)');
                return {
                    metadata: { version: "2.0" },
                    name: profile.contact.name || '',
                    email: profile.contact.email || '',
                    phone: profile.contact.phone || '',
                    location: profile.contact.location || '',
                    linkedin: profile.contact.linkedin || '',
                    experience: profile.experience || '',
                    skills: profile.skills || '',
                    education: profile.education || '',
                    certifications: profile.certifications || '',
                    projects: profile.projects || ''
                };
            }
            
            // Unknown format - return as-is and hope for the best
            console.warn('Unknown profile format, returning as-is:', profile);
            return profile;
        }

        function displayProfileForReview() {
            // Migrate to v2.0 if needed
            profileData = migrateProfileToV2(profileData);
            
            // Extract values (all v2.0 flat format now)
            const name = profileData.name || '';
            const email = profileData.email || '';
            const phone = profileData.phone || '';
            const location = profileData.location || '';
            const linkedin = profileData.linkedin || '';
            const experienceText = profileData.experience || '';
            const skillsText = profileData.skills || '';
            const educationText = profileData.education || '';
            const certificationsText = profileData.certifications || '';
            const projectsText = profileData.projects || '';
            
            const reviewDiv = document.getElementById('profile-review');
            reviewDiv.innerHTML = `
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="review-name" value="${escapeHtml(name)}">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="review-email" value="${escapeHtml(email)}">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="review-phone" value="${escapeHtml(phone)}">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="review-location" value="${escapeHtml(location)}">
                </div>
                <div class="form-group">
                    <label>LinkedIn</label>
                    <input type="url" id="review-linkedin" value="${escapeHtml(linkedin)}">
                </div>
                <div class="form-group">
                    <label>Work Experience</label>
                    <textarea id="review-experience" rows="15">${escapeHtml(experienceText)}</textarea>
                </div>
                <div class="form-group">
                    <label>Skills</label>
                    <textarea id="review-skills" rows="8">${escapeHtml(skillsText)}</textarea>
                </div>
                <div class="form-group">
                    <label>Projects</label>
                    <textarea id="review-projects" rows="6">${escapeHtml(projectsText)}</textarea>
                </div>
                <div class="form-group">
                    <label>Education</label>
                    <textarea id="review-education" rows="4">${escapeHtml(educationText)}</textarea>
                </div>
                <div class="form-group">
                    <label>Certifications</label>
                    <textarea id="review-certifications" rows="6">${escapeHtml(certificationsText)}</textarea>
                </div>
            `;
        }

        function editProfile() {
            // Get values from review fields
            const name = document.getElementById('review-name').value;
            const email = document.getElementById('review-email').value;
            const phone = document.getElementById('review-phone').value;
            const location = document.getElementById('review-location').value;
            const linkedin = document.getElementById('review-linkedin').value;
            const experience = document.getElementById('review-experience').value;
            const skills = document.getElementById('review-skills').value;
            const projects = document.getElementById('review-projects').value;
            const education = document.getElementById('review-education').value;
            const certifications = document.getElementById('review-certifications').value;
            
            // Validate required fields
            if (!validators.required(name)) {
                alert('Name is required');
                return false;
            }
            
            if (!validators.required(email)) {
                alert('Email is required');
                return false;
            }
            
            if (!validators.email(email)) {
                alert('Please enter a valid email address');
                return false;
            }
            
            if (phone && !validators.phone(phone)) {
                alert('Please enter a valid phone number');
                return false;
            }
            
            if (linkedin && !validators.url(linkedin)) {
                alert('Please enter a valid LinkedIn URL');
                return false;
            }
            
            // Update profile data - flat 1:1 structure
            profileData = {
                metadata: { version: "2.0" },
                name: name,
                email: email,
                phone: phone,
                location: location,
                linkedin: linkedin,
                experience: experience,
                skills: skills,
                projects: projects,
                education: education,
                certifications: certifications
            };
            
            // Navigate back to setup section to edit
            showSection('setup-section');
            return true;
        }

        async function confirmProfile() {
            editProfile(); // Save any changes
            
            // Save to storage
            try {
                await safeStorageSet('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('Error saving profile:', error);
            }
            
            showSection('job-analysis-section');
        }

        async function startOver() {
            if (confirm('This will delete your profile. Are you sure?')) {
                profileData = null;
                try {
                    await safeStorageDelete('job-assistant-profile');
                } catch (error) {
                    console.error('Error deleting profile:', error);
                }
                showSection('setup-section');
                hideManualEntry();
                hideDocumentUpload();
            }
        }

        async function analyzeJob() {
            const jobDesc = document.getElementById('job-description').value.trim();
            
            if (!jobDesc) {
                alert('Please paste a job description');
                return;
            }

            // Check if profile exists and has content
            if (!profileData) {
                alert('Please upload a document or manually enter your profile information first');
                return;
            }

            // Check if profile has actual content (not just empty fields)
            const hasContent = (profileData.experience && profileData.experience.trim()) ||
                             (profileData.skills && profileData.skills.trim()) ||
                             (profileData.education && profileData.education.trim()) ||
                             (profileData.certifications && profileData.certifications.trim());
            
            if (!hasContent) {
                alert('Your profile is empty. Please upload a document or manually enter your profile information first');
                return;
            }

            // Validate job description length
            if (jobDesc.length > 20000) {
                alert('Job description is too long. Please shorten to under 20,000 characters (currently ' + jobDesc.length.toLocaleString() + ' characters).\n\nTip: Copy only the actual job description, not the entire webpage.');
                return;
            }
            
            // Warning for very long descriptions
            if (jobDesc.length > 10000) {
                const proceed = confirm('This job description is quite long (' + jobDesc.length.toLocaleString() + ' characters).\n\nFor best results, use only the core job description (requirements, responsibilities, qualifications).\n\nProceed anyway?');
                if (!proceed) {
                    return;
                }
            }

            // Check if it's a URL
            if (jobDesc.startsWith('http://') || jobDesc.startsWith('https://') || jobDesc.startsWith('www.')) {
                const resultDiv = document.getElementById('analysis-result');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>üîó URL Detected</strong><br>
                        Due to browser security and employer website restrictions, this tool cannot fetch job descriptions from URLs directly.<br><br>
                        <strong>Please copy the job description text and paste it here instead.</strong>
                    </div>
                `;
                return;
            }

            currentJobDescription = jobDesc;
            
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing job match...</p></div>';

            try {
                const systemPrompt = `You are an experienced recruiter analyzing job match quality using a calibrated scoring system.

SCORING FRAMEWORK (Total = 100 points):
- Required Qualifications = 80 points (divide evenly among all required quals)
- Preferred/Bonus Qualifications = 20 points (divide evenly among all preferred quals)
- Maximum possible score = 100%

PARTIAL CREDIT RULES:
- Exact match = 100% of points for that qualification
- Close match = 90-95% of points (see specific rubrics below)
- Transferable skill = 60-80% of points (see industry equivalency table)
- Related but not direct = 60-70% of points
- Missing entirely = 0% of points

SECTION HEADER CLASSIFICATION (Fix: Required vs Preferred):
Identify REQUIRED qualifications (80-point bucket) from these indicators:
- Section headers: "Requirements", "Required Qualifications", "Must Have", "Minimum Qualifications", 
  "Who You Are", "What You'll Bring", "Essential Skills", "Basic Qualifications", "You Have"
- Inline keywords: "required", "must", "essential", "minimum", "mandatory"
- Items appearing before any "preferred" section

Identify PREFERRED qualifications (20-point bucket) from these indicators:
- Section headers: "Nice to Have", "Preferred", "Bonus", "Plus", "What Would Be Amazing", 
  "Ideal Candidate", "Bonus Points", "We'd Love If You Have"
- Inline keywords: "preferred", "nice to have", "bonus", "plus", "ideally", "optionally"

For AMBIGUOUS cases:
- "Qualifications" without modifier ‚Üí First 60% are required, last 40% are preferred
- "What We're Looking For" ‚Üí Look for inline keywords; if none, first items are required
- "About You" ‚Üí Hard skills and experience = required; soft skills and personality traits = preferred
- No clear structure ‚Üí Years of experience and technical skills = required; certifications and domain knowledge = preferred
- When in doubt: Classify as REQUIRED (conservative - doesn't unfairly penalize for missing nice-to-haves)

YEARS OF EXPERIENCE SCORING (Fix: Explicit rubric):
- Meets or exceeds requirement: 100% credit (e.g., 10+ years when 10 required)
- 1 year under requirement: 95% credit (e.g., 9 years when 10 required)
- 2 years under requirement: 90% credit (e.g., 8 years when 10 required)
- 3 years under requirement: 80% credit (e.g., 7 years when 10 required)
- 4 years under requirement: 70% credit (e.g., 6 years when 10 required)
- 5+ years under requirement: 50-60% credit depending on relevance (e.g., 5 years when 10 required)
- Less than half required: 25-35% credit (shows some experience but major gap)
- No experience in that role: 0% credit
IMPORTANT: Being over-qualified (15 years when 10 required) is NOT penalized - still 100% credit

DEGREE REQUIREMENTS SCORING (Fix: Explicit rules):
When job requires a Bachelor's degree:
- Master's or PhD in same/related field: 100% credit
- Bachelor's in exact field: 100% credit
- Bachelor's in closely related field: 90-95% credit (e.g., Software Eng when CS required)
- Bachelor's in broader related field: 85-90% credit (e.g., Math when CS required)
- Associate's degree in field: 70-80% credit
- No degree but 2x required experience: 60-75% credit (e.g., 10 years when 5 required + degree)
- No degree, meets experience requirement: 40-50% credit
- No degree, under experience requirement: 10-20% credit

When job requires a Master's degree:
- PhD in field: 100% credit
- Master's in exact field: 100% credit
- Master's in related field: 90-95% credit
- Bachelor's with significant experience (8+ years): 60-70% credit
- Bachelor's alone: 30-40% credit

TECHNOLOGY/TOOL NAME EQUIVALENCIES (Fix: Aliases):
Recognize these as identical:
- React = React.js = ReactJS
- Node = Node.js = NodeJS
- K8s = Kubernetes
- PostgreSQL = Postgres = psql
- JavaScript = JS
- TypeScript = TS
- Python 3 = Python3 = Python
- ML = Machine Learning
- AI = Artificial Intelligence
- AWS = Amazon Web Services
- GCP = Google Cloud Platform
- APIs = API
- DevOps = Dev Ops

COMBINED REQUIREMENTS PARSING (Fix: Multi-part requirements):
When a single bullet contains multiple concepts, treat as separate requirements:
- "5+ years experience in operations management with P&L responsibility" = 3 parts:
  * Years of experience (use years rubric)
  * Operations management (hard skill match)
  * P&L responsibility (specific skill match)
- "Python and SQL proficiency" = 2 parts:
  * Python (score separately)
  * SQL (score separately)
- Score each component and average them for that requirement

INDUSTRY/DOMAIN EQUIVALENCIES (Fix: Specific ranges):
Same role, different industry - use these ranges for transferable skills:
- Similar industries (fintech ‚Üí tech, healthcare tech ‚Üí SaaS): 75-80% credit
- Related industries (operations in retail ‚Üí operations in tech): 65-75% credit
- Different but transferable (healthcare ‚Üí fintech, automotive ‚Üí aerospace): 60-70% credit
- Very different industries (retail ‚Üí software, hospitality ‚Üí fintech): 55-65% credit
Focus on transferability of core skills (management, operations, analysis) over domain expertise

SCORE INTERPRETATION:
- 90-100%: Excellent Match - Meets all/nearly all required + strong on preferred
- 80-89%: Strong Match - Meets all required, some preferred
- 70-79%: Good Match - Meets most required, competitive candidate
- 60-69%: Fair Match - Meets minimum required, notable gaps
- Below 60%: Poor Match - Missing critical requirements

IMPORTANT GUIDELINES:
1. First, identify which qualifications are REQUIRED vs PREFERRED using section header rules above
2. Parse combined requirements (multi-part bullets) into separate scorable components
3. Calculate required score (out of 80 points) by evaluating each required qualification
4. Calculate preferred score (out of 20 points) by evaluating each preferred qualification
5. Apply specific rubrics: years (explicit scale), degrees (explicit rules), tech names (aliases)
6. Use industry equivalency ranges (55-80%) for transferable skills across domains
7. Focus on ability to DO THE JOB, not perfect credential matching
8. Certifications listed as "preferred" should not significantly impact score if missing

Candidate Profile:
${JSON.stringify(profileData, null, 2)}

Return your analysis in this JSON format:
{
  "matchScore": <number 0-100, calculated using the framework above>,
  "jobTitle": "<extracted job title>",
  "requiredQuals": {
    "total": <number of required qualifications>,
    "pointsEarned": <points earned out of 80>,
    "details": ["brief explanation of scoring for each required qual"]
  },
  "preferredQuals": {
    "total": <number of preferred qualifications>,
    "pointsEarned": <points earned out of 20>,
    "details": ["brief explanation of scoring for each preferred qual"]
  },
  "strengths": ["strength1", "strength2", ...],
  "gaps": ["gap1", "gap2", ...],
  "recommendations": ["rec1", "rec2", ...]
}`;

                const response = await callClaudeAPI(systemPrompt, `Job Description:\n${jobDesc}`);
                currentAnalysis = JSON.parse(response);
                
                displayAnalysisResults();
            } catch (error) {
                console.error('Error analyzing job:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">Error analyzing job. Please try again.</div>`;
            }
        }

        function displayAnalysisResults() {
            const score = currentAnalysis.matchScore;
            let matchClass = 'match-poor';
            let matchText = 'Poor Match';
            
            if (score >= 90) {
                matchClass = 'match-excellent';
                matchText = 'Excellent Match';
            } else if (score >= 80) {
                matchClass = 'match-good';
                matchText = 'Strong Match';
            } else if (score >= 70) {
                matchClass = 'match-fair';
                matchText = 'Good Match';
            } else if (score >= 60) {
                matchClass = 'match-fair';
                matchText = 'Fair Match';
            }

            const resultDiv = document.getElementById('analysis-result');
            
            // Build score breakdown HTML
            let scoreBreakdown = '';
            if (currentAnalysis.requiredQuals && currentAnalysis.preferredQuals) {
                const reqPercentage = ((currentAnalysis.requiredQuals.pointsEarned / 80) * 100).toFixed(0);
                const prefPercentage = currentAnalysis.preferredQuals.total > 0 
                    ? ((currentAnalysis.preferredQuals.pointsEarned / 20) * 100).toFixed(0) 
                    : 0;
                
                scoreBreakdown = `
                    <div style="background: #f9fafb; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h4 style="margin-bottom: 16px;">üìä Score Breakdown</h4>
                        <div style="margin-bottom: 12px;">
                            <strong>Required Qualifications:</strong> ${currentAnalysis.requiredQuals.pointsEarned.toFixed(1)}/80 points (${reqPercentage}%)
                            <div style="font-size: 13px; color: #cbd5e1; margin-top: 4px;">
                                ${currentAnalysis.requiredQuals.details.map(d => `‚Ä¢ ${d}`).join('<br>')}
                            </div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong>Preferred Qualifications:</strong> ${currentAnalysis.preferredQuals.pointsEarned.toFixed(1)}/20 points (${prefPercentage}%)
                            <div style="font-size: 13px; color: #cbd5e1; margin-top: 4px;">
                                ${currentAnalysis.preferredQuals.details.map(d => `‚Ä¢ ${d}`).join('<br>')}
                            </div>
                        </div>
                        <div style="border-top: 2px solid #667eea; padding-top: 12px; margin-top: 12px;">
                            <strong>Total Score:</strong> ${score}%
                        </div>
                    </div>
                `;
            }

            resultDiv.innerHTML = `
                <h3>Job Match Analysis</h3>
                <div class="match-badge ${matchClass}">${matchText}: ${score}%</div>
                
                ${scoreBreakdown}
                
                <h4 style="margin-top: 24px;">‚úÖ Strengths</h4>
                <ul style="margin: 12px 0; padding-left: 24px;">
                    ${currentAnalysis.strengths.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                </ul>
                
                ${currentAnalysis.gaps && currentAnalysis.gaps.length > 0 ? `
                    <h4 style="margin-top: 24px;">‚ö†Ô∏è Gaps</h4>
                    <ul style="margin: 12px 0; padding-left: 24px;">
                        ${currentAnalysis.gaps.map(g => `<li>${escapeHtml(g)}</li>`).join('')}
                    </ul>
                    <div style="margin-top: 20px; padding: 20px; background: white; border: 2px solid #f59e0b; border-radius: 8px;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">üìù How have you addressed these gaps? (Optional)</h4>
                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 10px; font-style: italic;">
                            Add context about skills, projects, or experience that address the gaps above. This helps create a more accurate resume.
                        </p>
                        <textarea id="gap-context" placeholder="Example: Completed IBM Generative AI certification (Dec 2025), built AI-powered Rovo agents reducing time by 99%, work daily with SQL and data visualization..." style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #d97706; border-radius: 6px; font-family: inherit; font-size: 14px;"></textarea>
                        <p style="color: #6b7280; font-size: 13px; margin-top: 8px; font-style: italic;">
                            This information will be incorporated naturally into your resume and cover letter.
                        </p>
                    </div>
                ` : ''}
                
                <h4 style="margin-top: 24px;">üí° Recommendations</h4>
                <ul style="margin: 12px 0; padding-left: 24px;">
                    ${currentAnalysis.recommendations.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
                </ul>
                
                <div class="button-group" style="margin-top: 32px;">
                    ${currentAnalysis.gaps && currentAnalysis.gaps.length > 0 ? `
                        <button class="btn-secondary" onclick="editProfileToAddressGaps()">Edit Profile to Address Gaps</button>
                    ` : ''}
                    ${score >= 70 ? `
                        <button class="btn-primary" onclick="generateResume()">Generate Resume</button>
                        <button class="btn-secondary" onclick="generateCoverLetter()">Generate Cover Letter</button>
                    ` : `
                        <button class="btn-secondary" onclick="editProfileToAddressGaps()">Edit Profile</button>
                        <button class="btn-secondary" onclick="startNewJobAnalysis()">Try Another Job</button>
                    `}
                </div>
            `;
        }

        function editProfileToAddressGaps() {
            // Show the review section pre-filled with current data so user can edit
            displayProfileForReview();
            showSection('review-section');
            
            // Add a helpful message at the top
            const reviewSection = document.getElementById('review-section');
            const existingAlert = reviewSection.querySelector('.edit-gaps-alert');
            if (!existingAlert) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-info edit-gaps-alert';
                alert.innerHTML = `
                    <strong>üí° Edit Your Profile</strong><br>
                    Update your profile to address the gaps identified in the job analysis. 
                    Add missing skills, experience, or qualifications that you have but weren't in your original profile.
                    <br><br>
                    <button class="btn-secondary" onclick="returnToAnalysis()" style="margin-top: 12px;">Return to Analysis</button>
                `;
                reviewSection.insertBefore(alert, reviewSection.querySelector('h2').nextSibling);
            }
        }

        function returnToAnalysis() {
            // Remove the alert
            const alert = document.querySelector('.edit-gaps-alert');
            if (alert) alert.remove();
            
            // Re-run the analysis with updated profile
            if (currentJobDescription) {
                showSection('job-analysis-section');
                // Automatically re-analyze with updated profile
                setTimeout(() => {
                    analyzeJob();
                }, 500);
            } else {
                showSection('job-analysis-section');
            }
        }


        async function reAnalyzeWithResume(resumeText) {
            try {
                const systemPrompt = `You are an experienced recruiter analyzing job match quality using a calibrated scoring system.

SCORING FRAMEWORK (Total = 100 points):
- Required Qualifications = 80 points (divide evenly among all required quals)
- Preferred/Bonus Qualifications = 20 points (divide evenly among all preferred quals)
- Maximum possible score = 100%

PARTIAL CREDIT RULES:
- Exact match = 100% of points for that qualification
- Close match (e.g., 9 years when 10+ required, related certification) = 90-95% of points
- Transferable skill (e.g., fintech ops when data center ops required) = 60-80% of points based on relevance
- Related but not direct (e.g., AI infrastructure when data center infrastructure required) = 60-70% of points
- Missing entirely = 0% of points

SCORE INTERPRETATION:
- 90-100%: Excellent Match - Meets all/nearly all required + strong on preferred
- 80-89%: Strong Match - Meets all required, some preferred
- 70-79%: Good Match - Meets most required, competitive candidate
- 60-69%: Fair Match - Meets minimum required, notable gaps
- Below 60%: Poor Match - Missing critical requirements

IMPORTANT: This is a TAILORED RESUME based on the original profile. Score it objectively against the job requirements. It may score HIGHER if well-optimized and emphasizes relevant skills, LOWER if important details were omitted due to space constraints, or EQUAL if it's a faithful representation. Do not assume it should score higher just because it was generated. However, when scoring transferable skills, be fair (e.g., if they have "data infrastructure" and job wants "AI infrastructure," that counts as related experience). Skills must actually exist in the resume - do not assume skills that aren't listed.

Job Description:
${currentJobDescription}

Tailored Resume:
${resumeText}

CRITICAL: Respond with ONLY valid JSON, no other text. Use this exact format:
{
    "matchPercentage": 85,
    "matchLabel": "Strong Match",
    "keywordsAdded": 15,
    "atsCompatible": true,
    "bulletMetrics": 80,
    "improvementAreas": ["area1", "area2"]
}`;

                const response = await callClaudeAPI(systemPrompt, 'Analyze this resume against the job description.');
                
                // Extract JSON from response - handle various formats
                let jsonText = response.trim();
                
                // Remove markdown code fences
                jsonText = jsonText.replace(/```json\n?/g, '');
                jsonText = jsonText.replace(/```\n?/g, '');
                
                // Find JSON object boundaries
                const firstBrace = jsonText.indexOf('{');
                const lastBrace = jsonText.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1) {
                    jsonText = jsonText.substring(firstBrace, lastBrace + 1);
                }
                
                return JSON.parse(jsonText);
            } catch (error) {
                console.error('Error re-analyzing resume:', error);
                console.error('Response was:', response);
                return null;
            }
        }

        function getMatchLabel(matchPercentage) {
            if (matchPercentage >= 90) return 'Excellent Match';
            if (matchPercentage >= 80) return 'Strong Match';
            if (matchPercentage >= 70) return 'Good Match';
            if (matchPercentage >= 60) return 'Fair Match';
            return 'Poor Match';
        }

        function getATSLabel(score) {
            if (score >= 90) return '‚úÖ Excellent';
            if (score >= 80) return '‚úÖ Very Good';
            if (score >= 70) return 'üü° Good';
            if (score >= 60) return 'üü° Fair';
            return '‚ö†Ô∏è Needs Improvement';
        }

        function getCategoryIcon(score) {
            if (score >= 85) return '‚úÖ';
            if (score >= 70) return 'üü°';
            return '‚ö†Ô∏è';
        }

        function toggleATSDetails() {
            const details = document.getElementById('ats-details');
            const button = event.target;
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                button.textContent = 'Hide Details ‚ñ≤';
            } else {
                details.classList.add('hidden');
                button.textContent = 'Show Details ‚ñº';
            }
        }

        function displayATSBadge(atsData) {
            if (!atsData) return '';
            
            return `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            padding: 20px; 
                            border-radius: 12px; 
                            margin-bottom: 24px;
                            color: white;
                            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">ATS Compatibility Score</div>
                            <div style="font-size: 36px; font-weight: 800;">${atsData.overallScore}%</div>
                            <div style="font-size: 16px; opacity: 0.95;">${getATSLabel(atsData.overallScore)}</div>
                        </div>
                        <button onclick="toggleATSDetails()" 
                                class="btn-secondary" 
                                style="background: rgba(255,255,255,0.2); 
                                       border: 1px solid rgba(255,255,255,0.3);
                                       color: white;
                                       padding: 12px 24px;">
                            Show Details ‚ñº
                        </button>
                    </div>
                </div>
                
                <div id="ats-details" class="hidden" style="background: #f8fafc; 
                                                             padding: 24px; 
                                                             border-radius: 12px; 
                                                             margin-bottom: 24px;
                                                             border: 2px solid #e2e8f0;">
                    <h4 style="color: #1e293b; margin-bottom: 20px; font-size: 18px;">üìä ATS Compatibility Breakdown</h4>
                    
                    ${Object.entries(atsData.categories).map(([key, data]) => `
                        <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px; border-left: 4px solid ${data.score >= 85 ? '#10b981' : data.score >= 70 ? '#f59e0b' : '#ef4444'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #334155; text-transform: capitalize;">${getCategoryIcon(data.score)} ${key}</strong>
                                <span style="font-size: 20px; font-weight: 700; color: #667eea;">${data.score}%</span>
                            </div>
                            <p style="color: #64748b; margin: 0; font-size: 14px;">${data.feedback}</p>
                        </div>
                    `).join('')}
                    
                    ${atsData.recommendations && atsData.recommendations.length > 0 ? `
                        <div style="background: #dbeafe; padding: 16px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #3b82f6;">
                            <strong style="color: #1e40af; display: block; margin-bottom: 12px;">üí° Recommendations</strong>
                            <ul style="margin: 0; padding-left: 20px; color: #1e3a8a;">
                                ${atsData.recommendations.map(rec => `<li style="margin-bottom: 8px;">${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <p style="color: #64748b; font-size: 13px; margin-top: 16px; font-style: italic;">
                        ‚ÑπÔ∏è This analysis is for your reference only and won't appear in downloaded documents.
                    </p>
                </div>
            `;
        }

        function displayMatchComparison(originalMatch, newMatch, originalATS = null, newATS = null) {
            const improvement = newMatch.matchPercentage - originalMatch;
            const scoreWentDown = improvement < 0;
            
            // If score went down, show different message with choice
            if (scoreWentDown) {
                const atsImprovement = (newATS && originalATS) ? newATS.overallScore - originalATS.overallScore : 0;
                
                return `
                    <div style="margin: 30px 0; padding: 25px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 20px; font-size: 18px;">‚ö†Ô∏è Tailored Resume Scored Lower</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                                <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Original Profile</div>
                                <div style="font-size: 32px; font-weight: bold; color: #667eea; margin: 10px 0;">${originalMatch}%</div>
                                <div style="color: #059669; font-weight: 600;">${getMatchLabel(originalMatch)}</div>
                                ${originalATS ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                        <div style="color: #6b7280; font-size: 11px; margin-bottom: 4px;">ATS Score</div>
                                        <div style="font-size: 20px; font-weight: 600; color: #667eea;">${originalATS.overallScore}%</div>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #fca5a5;">
                                <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Tailored Resume</div>
                                <div style="font-size: 32px; font-weight: bold; color: #dc2626; margin: 10px 0;">${newMatch.matchPercentage}%</div>
                                <div style="color: #dc2626; font-weight: 600;">${newMatch.matchLabel} (${improvement} points)</div>
                                ${newATS ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                        <div style="color: #6b7280; font-size: 11px; margin-bottom: 4px;">ATS Score</div>
                                        <div style="font-size: 20px; font-weight: 600; color: ${atsImprovement > 0 ? '#059669' : '#dc2626'};">
                                            ${newATS.overallScore}% ${atsImprovement > 0 ? `<span style="font-size: 14px;">(+${atsImprovement})</span>` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h5 style="color: #059669; margin-bottom: 12px;">‚úÖ Changes Made in Tailored Resume:</h5>
                            <ul style="margin-left: 20px; color: #374151; line-height: 1.8;">
                                <li><strong>Keywords:</strong> Added ${newMatch.keywordsAdded} relevant keywords from job description</li>
                                <li><strong>Format:</strong> ${newMatch.atsCompatible ? 'ATS-friendly ‚úì' : 'Standard format'}</li>
                                <li><strong>Quantification:</strong> ${newMatch.bulletMetrics}% of bullets include metrics</li>
                                ${newATS && atsImprovement > 0 ? `<li><strong>ATS Optimization:</strong> Improved ATS score by ${atsImprovement} points</li>` : ''}
                            </ul>
                            <p style="color: #6b7280; font-size: 14px; margin-top: 12px; font-style: italic;">
                                ${atsImprovement > 0 ? 
                                    'The tailored resume has significantly better ATS compatibility despite the lower match score.' :
                                    'Despite the lower score, the resume has better keyword optimization and formatting for ATS systems.'}
                            </p>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px;">
                            <h5 style="color: #92400e; margin-bottom: 12px;">Which version would you like to use?</h5>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 15px;">
                                <button class="btn-secondary" onclick="useOriginalProfile()" style="flex: 1; min-width: 180px;">
                                    Use Original Profile
                                    <div style="font-size: 11px; font-weight: normal; margin-top: 4px;">Higher match score (${originalMatch}%)</div>
                                </button>
                                <button class="btn-primary" onclick="keepTailoredResume()" style="flex: 1; min-width: 180px;">
                                    Use Tailored Resume
                                    <div style="font-size: 11px; font-weight: normal; margin-top: 4px; opacity: 0.9;">Better ATS compatibility${newATS ? ` (${newATS.overallScore}%)` : ''}</div>
                                </button>
                                <button class="btn-secondary" onclick="regenerateResume()" style="flex: 1; min-width: 180px;">
                                    Regenerate Resume
                                    <div style="font-size: 11px; font-weight: normal; margin-top: 4px;">Try different approach</div>
                                </button>
                                <button class="btn-secondary" onclick="showSection('job-analysis-section')" style="flex: 1; min-width: 180px;">
                                    Back to Analysis
                                    <div style="font-size: 11px; font-weight: normal; margin-top: 4px;">Add more context</div>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Normal case: score improved or stayed same
            const improvementColor = improvement > 0 ? '#059669' : '#6b7280';
            const atsImprovement = (newATS && originalATS) ? newATS.overallScore - originalATS.overallScore : 0;
            
            return `
                <div style="margin: 30px 0; padding: 25px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 20px; font-size: 18px;">üìä Match Score Comparison</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                            <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Original Profile</div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea; margin: 10px 0;">${originalMatch}%</div>
                            <div style="color: #059669; font-weight: 600;">${getMatchLabel(originalMatch)}</div>
                            ${originalATS ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="color: #6b7280; font-size: 11px; margin-bottom: 4px;">ATS Score</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${originalATS.overallScore}%</div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                            <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Improvement</div>
                            <div style="font-size: 32px; font-weight: bold; color: ${improvementColor}; margin: 10px 0;">${improvement > 0 ? '+' : ''}${improvement}</div>
                            <div style="color: #6b7280; font-size: 14px;">Match points</div>
                            ${atsImprovement !== 0 ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 20px; font-weight: 600; color: ${atsImprovement > 0 ? '#059669' : '#dc2626'};">${atsImprovement > 0 ? '+' : ''}${atsImprovement}</div>
                                    <div style="color: #6b7280; font-size: 12px;">ATS points</div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                            <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Tailored Resume</div>
                            <div style="font-size: 32px; font-weight: bold; color: #059669; margin: 10px 0;">${newMatch.matchPercentage}%</div>
                            <div style="color: #059669; font-weight: 600;">${newMatch.matchLabel}</div>
                            ${newATS ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="color: #6b7280; font-size: 11px; margin-bottom: 4px;">ATS Score</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #059669;">${newATS.overallScore}%</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #d1fae5;">
                        <h5 style="color: #059669; margin-bottom: 12px;">‚úÖ ATS Compatibility Check</h5>
                        <ul style="margin-left: 20px; color: #374151; line-height: 1.8;">
                            <li><strong>Keywords Added:</strong> ${newMatch.keywordsAdded} relevant keywords from job description</li>
                            <li><strong>Format:</strong> ${newMatch.atsCompatible ? 'ATS-friendly ‚úì' : 'Needs adjustment ‚ö†Ô∏è'}</li>
                            <li><strong>Quantification:</strong> ${newMatch.bulletMetrics}% of bullets include metrics</li>
                            ${improvement > 0 ? '<li><strong>Status:</strong> Significantly improved match! üéâ</li>' : ''}
                        </ul>
                    </div>
                </div>
            `;
        }

        function keepTailoredResume() {
            // User chose to use the tailored resume despite lower score
            // Replace the warning with a confirmation message
            const warningBox = document.querySelector('[style*="border-left: 4px solid #f59e0b"]');
            if (warningBox) {
                warningBox.innerHTML = `
                    <div style="background: #d1fae5; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚úì</div>
                        <strong style="color: #059669; font-size: 18px;">Using Tailored Resume</strong>
                        <p style="margin: 12px 0 0 0; color: #047857;">
                            You can download it below or generate a cover letter.
                        </p>
                    </div>
                `;
                // Scroll to resume
                warningBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function regenerateResume() {
            // Simply call generateResume again to create a new version
            generateResume();
        }

        async function useOriginalProfile() {
            // User wants to use their original profile without aggressive tailoring
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating resume with original profile...</p></div>';
            showSection('results-section');

            try {
                // Create profile copy with conditional location
                const profileForResume = {...profileData};
                if (!shouldIncludeLocation()) {
                    profileForResume.contact = {...profileForResume.contact, location: ''};
                }
                
                const systemPrompt = `You are an expert resume writer. Create a professional, ATS-friendly resume.

IMPORTANT INSTRUCTIONS:
- Stay very close to the candidate's original profile
- Do NOT heavily tailor or modify the content
- Keep the candidate's original phrasing and descriptions
- Only make minor formatting improvements
- Maintain the candidate's authentic voice
- Focus on clean, professional formatting
- Use standard resume sections

Candidate Profile:
${JSON.stringify(profileForResume, null, 2)}

Job Description (for context only - do not over-tailor):
${currentJobDescription}

Create a professional resume that faithfully represents the candidate's original profile.
Use clear section headers, bullet points, and proper formatting.

IMPORTANT: After generating the resume, provide an ATS compatibility analysis.

Return your response in this EXACT format:

RESUME:
[full resume text here]

ATS_ANALYSIS:
{
  "overallScore": 85,
  "categories": {
    "format": {
      "score": 95,
      "feedback": "Clean single-column layout with standard fonts."
    },
    "keywords": {
      "score": 75,
      "feedback": "Uses candidate's natural terminology. Some job-specific keywords could be added."
    },
    "structure": {
      "score": 90,
      "feedback": "All standard sections present with clear headers."
    },
    "quantification": {
      "score": 80,
      "feedback": "Good use of metrics from original profile."
    }
  },
  "recommendations": [
    "Consider adding 2-3 more industry-specific keywords if applying to companies with strict ATS"
  ]
}`;

                const response = await callClaudeAPI(systemPrompt, 'Please create a professional resume based on my profile.');
                
                // Parse response to extract resume and ATS analysis
                let resume = response;
                let atsData = null;
                
                const resumeMatch = response.match(/RESUME:\s*([\s\S]*?)\s*ATS_ANALYSIS:/);
                const atsMatch = response.match(/ATS_ANALYSIS:\s*(\{[\s\S]*\})/);
                
                if (resumeMatch && atsMatch) {
                    resume = resumeMatch[1].trim();
                    try {
                        atsData = JSON.parse(atsMatch[1]);
                    } catch (error) {
                        console.error('Error parsing ATS data:', error);
                    }
                } else {
                    console.log('ATS analysis not found in expected format, using full response as resume');
                }
                
                // Store for DOCX download and future use
                currentResumeText = resume;
                currentResumeATS = atsData;
                
                // Save to generated files
                addGeneratedFile('resume', currentAnalysis.jobTitle, resume);
                
                resultsContent.innerHTML = `
                    <div style="background: #d1fae5; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚úì</div>
                        <strong style="color: #059669; font-size: 18px;">Using Original Profile</strong>
                        <p style="margin: 12px 0 0 0; color: #047857;">
                            Resume generated with minimal tailoring to preserve your original match score.
                        </p>
                    </div>
                    <h3>Your Resume</h3>
                    ${displayATSBadge(atsData)}
                    <div class="document-output">${resume}</div>
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn-secondary" onclick="copyToClipboard(\`${resume.replace(/[`]/g, '\\`')}\`)">Copy Text</button>
                        <button class="btn-primary" onclick="downloadResumeAsDOCX()">Download as DOCX</button>
                    </div>
                    <div class="button-group" style="margin-top: 16px; border-top: 2px solid #e5e7eb; padding-top: 24px;">
                        <button class="btn-secondary" onclick="startNewJobAnalysis()">‚Üê Analyze Another Job</button>
                        <button class="btn-primary" onclick="generateCoverLetter()">Generate Cover Letter ‚Üí</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating resume:', error);
                resultsContent.innerHTML = `<div class="alert alert-danger">Error generating resume. Please try again.</div>`;
            }
        }

        // Helper: Update progress indicator
        function updateResumeProgress(message, percent) {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 8px; height: 8px; margin-top: 16px;">
                        <div style="width: ${percent}%; background: #14b8a6; height: 100%; border-radius: 8px; transition: width 0.3s;"></div>
                    </div>
                    <p style="color: #64748b; font-size: 14px; margin-top: 8px;">${percent}% complete</p>
                </div>
            `;
        }

        // CHUNK 1: Professional Summary + Core Competencies
        async function generateSummarySection(contact, experience, skills, jobInfo, gapContext) {
            const experiencePreview = typeof experience === 'string' ? experience.substring(0, 500) : 'See work history';
            const skillsPreview = typeof skills === 'string' ? skills.substring(0, 300) : 'Various skills';
            
            const prompt = `Generate a professional summary and core competencies section for a resume.

CANDIDATE CONTACT INFORMATION (MUST INCLUDE AT TOP):
Name: ${contact.name}
Email: ${contact.email}
Phone: ${contact.phone}
${contact.location ? `Location: ${contact.location}` : ''}
${contact.linkedin ? `LinkedIn: ${contact.linkedin}` : ''}

EXPERIENCE PREVIEW: ${experiencePreview}

SKILLS PREVIEW: ${skillsPreview}

TARGET JOB:
- Title: ${jobInfo.title}
- Company: ${jobInfo.company}
- Match Score: ${jobInfo.matchScore}%
- Top Strengths: ${jobInfo.topStrengths.join(', ')}
- Key Requirements: ${jobInfo.keyRequirements.join(', ')}

${gapContext ? `GAP CONTEXT: ${gapContext}` : ''}

CRITICAL REQUIREMENTS - READ CAREFULLY:

1. CONTACT INFORMATION HEADER:
   - START the resume with contact info in this format:
   **${contact.name}**
   ${contact.email} | ${contact.phone}${contact.location ? ` | ${contact.location}` : ''}${contact.linkedin ? ` | ${contact.linkedin}` : ''}

2. Professional Summary (3-4 sentences):
   - Use ONLY information from the experience preview above
   - Lead with years of experience and core expertise
   - Highlight 2-3 key achievements that are actually mentioned in experience
   - NEVER invent accomplishments, metrics, or skills not in the preview
   - Be direct: "I do X, Y, Z" not "I am an expert with proven track record"
   
3. Core Competencies:
   - List ONLY skills explicitly mentioned in the skills preview above
   - NEVER add skills from the job description that aren't in candidate's background
   - NEVER invent technologies, tools, or methodologies not mentioned
   - Group by theme (e.g., "Operations & Implementation: Jira | Confluence | Agile")
   - 4-6 grouped categories maximum
   - If uncertain whether a skill is in the preview, leave it out

4. Tone - AVOID AI CLICH√âS:
   - BANNED WORDS: "spearheaded", "orchestrated", "game-changing", "proven track record", "rockstar", "synergy", "leverage", "deep dive"
   - Natural, professional, confident
   - Use clear, direct language

5. TRUTHFULNESS OVER COMPLETENESS:
   - Better to have a shorter, accurate summary than a padded one with fake information
   - User is legally responsible for accuracy - do not put false information
   - When in doubt, leave it out

Return markdown with contact header first, then summary, then competencies.`;

            const response = await callClaudeAPI(prompt, 'Generate professional summary and competencies.');
            return response;
        }

        // CHUNK 2: Recent Professional Experience
        async function generateRecentExperience(experience, jobInfo, gapContext) {
            const experienceText = typeof experience === 'string' ? experience : JSON.stringify(experience, null, 2);
            const recentExperience = experienceText.substring(0, 3000);
            
            const prompt = `Generate professional experience section for RECENT ROLES ONLY (last 2-3 jobs).

RECENT WORK HISTORY:
${recentExperience}

TARGET JOB: ${jobInfo.title} at ${jobInfo.company}
KEY REQUIREMENTS: ${jobInfo.keyRequirements.join(', ')}

${gapContext ? `GAP CONTEXT: ${gapContext}` : ''}

CRITICAL ANTI-FABRICATION REQUIREMENTS:

1. BULLET COUNT:
   - Most recent role: 5-7 bullets with extensive detail
   - Next 1-2 roles: 4-5 bullets each
   
2. TRUTHFULNESS - ABSOLUTELY CRITICAL:
   - Use ONLY achievements and information actually mentioned in the work history above
   - NEVER invent metrics, percentages, dollar amounts, or performance improvements
   - NEVER guess at team sizes, project counts, or timeframes not explicitly stated
   - NEVER add accomplishments that aren't in the work history
   - If you see a metric in the work history (like "99% reduction" or "$150K savings"), you can use it
   - If you don't see a metric, DO NOT make one up
   - Better to have bullets without numbers than bullets with fake numbers
   
3. EACH BULLET MUST:
   - Start with action verb (NOT "spearheaded", "orchestrated", "facilitated")
   - Describe a specific achievement or project mentioned in work history
   - Add quantified impact ONLY if actually mentioned in the work history
   - Use actual tool/system names from the work history
   - Be 1-2 lines maximum

4. FORMAT:
   - Include: Company Name | Location | Title | Dates (use exact info from work history)
   - Vary bullet lengths naturally (some 1 line, some 2 lines)

5. BANNED WORDS/PHRASES:
   - "spearheaded", "orchestrated", "facilitated", "drove", "championed"
   - "game-changing", "rockstar", "synergy", "leverage", "deep dive"
   - "proven track record", "extensive experience", "passionate about"

6. LEGAL WARNING:
   - User is legally responsible for accuracy
   - Do not put false information that could harm them in background checks
   - When in doubt about whether something was mentioned, leave it out
   - Truthfulness > Impressiveness

Return markdown for recent professional experience section only. Use ## PROFESSIONAL EXPERIENCE as header.`;

            const response = await callClaudeAPI(prompt, 'Generate recent experience.');
            return response;
        }

        // CHUNK 3: Older Professional Experience
        async function generateOlderExperience(experience, jobInfo) {
            const experienceText = typeof experience === 'string' ? experience : JSON.stringify(experience, null, 2);
            const olderExperience = experienceText.substring(3000, 6000);
            
            if (olderExperience.length < 100) {
                return '';
            }
            
            const prompt = `Generate professional experience for OLDER ROLES (beyond most recent 2-3).

OLDER WORK HISTORY:
${olderExperience}

TARGET JOB: ${jobInfo.title}

CRITICAL REQUIREMENTS:

1. TRUTHFULNESS:
   - Use ONLY information explicitly stated in the work history above
   - NEVER invent accomplishments, metrics, or responsibilities
   - If a role is mentioned but has minimal detail, keep bullets minimal
   - Better to have 1-2 accurate bullets than 3-4 fabricated ones

2. BULLET COUNT:
   - 2-3 bullets per role maximum
   - Focus on relevant skills/experience for target job
   - Be concise but specific

3. FORMAT:
   - Include: Company Name | Location | Title | Dates (exact from work history)
   - Use only information explicitly provided

4. BANNED WORDS:
   - NO "spearheaded", "orchestrated", "facilitated", "drove", "championed"

Return markdown for older experience section only. If no older experience exists in the provided text, return empty string.`;

            const response = await callClaudeAPI(prompt, 'Generate older experience.');
            return response;
        }

        // CHUNK 4: Projects Section
        async function generateProjectsSection(projects, jobInfo) {
            const projectsText = typeof projects === 'string' ? projects.substring(0, 1500) : JSON.stringify(projects, null, 2).substring(0, 1500);
            
            const prompt = `Generate a Projects section for resume.

PROJECTS FROM CANDIDATE'S PROFILE:
${projectsText}

TARGET JOB: ${jobInfo.title}

CRITICAL ANTI-FABRICATION REQUIREMENTS:

1. ONLY USE PROJECTS EXPLICITLY LISTED ABOVE:
   - NEVER invent projects not mentioned in the candidate's profile
   - NEVER make up project names, descriptions, or outcomes
   - If the projects section above is empty or minimal, return "## PROJECTS" with only what's listed
   - If no projects are provided, return empty string (no projects section)

2. FORMAT:
   - **Project Name** - Brief description (1-2 lines)
   - Use exact project names from the profile
   - Mention only technologies actually mentioned in the profile
   - Show only outcomes/impact explicitly stated in the profile

3. SELECTION:
   - Include only technical projects relevant to target job
   - 2-4 projects maximum
   - If fewer than 2 projects are mentioned in profile, only include what exists

4. TRUTHFULNESS:
   - Better to have 1 real project than 4 made-up ones
   - User is legally responsible for accuracy
   - Do not fabricate to fill space

Return markdown for projects section. Use ## PROJECTS as header. If no projects in profile, return empty string.`;

            const response = await callClaudeAPI(prompt, 'Generate projects section.');
            return response;
        }

        // CHUNK 5: Education & Certifications
        async function generateEducationSection(education, certifications) {
            const eduText = typeof education === 'string' ? education.substring(0, 800) : JSON.stringify(education, null, 2).substring(0, 800);
            const certText = typeof certifications === 'string' ? certifications.substring(0, 1200) : JSON.stringify(certifications, null, 2).substring(0, 1200);
            
            const prompt = `Generate Education and Certifications sections.

EDUCATION FROM CANDIDATE'S PROFILE:
${eduText}

CERTIFICATIONS FROM CANDIDATE'S PROFILE:
${certText}

üö® CRITICAL ANTI-FABRICATION REQUIREMENTS - READ CAREFULLY üö®

THIS IS THE MOST IMPORTANT INSTRUCTION:
- NEVER, EVER invent degrees, schools, or certifications
- Use ONLY the exact education and certifications listed above
- Do NOT add degrees to "look better" or "fill space"
- Do NOT assume the candidate has any education not explicitly listed
- Do NOT add certifications not explicitly mentioned
- If education section above is empty/minimal, list only what's there
- If certifications section above is empty/minimal, list only what's there

EDUCATION SECTION:
1. List ONLY degrees explicitly mentioned in the education text above
2. Use exact institution names from the text above
3. Use exact locations from the text above
4. Use exact years from the text above
5. If no formal degrees are listed, you can include relevant coursework or training ONLY if mentioned
6. Most recent first
7. Format: Degree | Institution, Location | Year

CERTIFICATIONS SECTION:
1. List ONLY certifications explicitly mentioned in the certifications text above
2. Use exact certification names from the text above
3. Use exact issuing organizations from the text above
4. Use exact years/dates from the text above
5. Most recent first
6. Format: Certification Name | Issuing Organization | Year

LEGAL WARNING:
- Education fraud can result in termination and legal action
- User is legally responsible for accuracy
- Better to have minimal education section than fabricated credentials
- When in doubt, leave it out

Return markdown with ## EDUCATION and ## CERTIFICATIONS headers. Keep concise - just the facts.`;

            const response = await callClaudeAPI(prompt, 'Generate education and certifications.');
            return response;
        }

        // CHUNK 6: ATS Analysis
        async function generateATSAnalysis(fullResume, jobDescription) {
            const prompt = `Analyze this resume for ATS compatibility.

RESUME (excerpt):
${fullResume.substring(0, 2000)}

JOB DESCRIPTION (excerpt):
${jobDescription.substring(0, 1000)}

Provide honest assessment of the resume's ATS compatibility based on what's actually in the resume. Do not suggest adding information that wasn't in the original profile.

Return ONLY valid JSON:
{
  "overallScore": 85,
  "categories": {
    "format": {"score": 95, "feedback": "Clean layout, excellent ATS compatibility."},
    "keywords": {"score": 82, "feedback": "Good keyword coverage."},
    "structure": {"score": 90, "feedback": "Well-organized."},
    "quantification": {"score": 85, "feedback": "Good use of metrics."}
  },
  "recommendations": ["Add specific keywords that are in the job description and match actual experience", "Include more tools/technologies actually used"]
}`;

            const response = await callClaudeAPI(prompt, 'Analyze ATS compatibility.');
            
            try {
                return JSON.parse(response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim());
            } catch (error) {
                console.error('Error parsing ATS analysis:', error);
                return null;
            }
        }

        // Combine sections into final resume
        function combineResumeSections(summary, recentExp, olderExp, projects, education) {
            let resume = '';
            if (summary) resume += summary + '\n\n';
            if (recentExp) resume += recentExp + '\n\n';
            if (olderExp) resume += olderExp + '\n\n';
            if (projects) resume += projects + '\n\n';
            if (education) resume += education;
            return resume.trim();
        }

        // Main chunked generation function
        async function generateResume() {
            // Check acknowledgment first
            if (!checkAcknowledgmentBeforeGeneration(() => generateResume())) {
                return;
            }

            // Validate profile data exists
            if (!profileData) {
                alert('No profile data found. Please upload your resume first.');
                showSection('setup-section');
                return;
            }

            // Validate job analysis exists
            if (!currentAnalysis || !currentJobDescription) {
                alert('No job analysis found. Please analyze a job first.');
                showSection('job-analysis-section');
                return;
            }

            const resultsContent = document.getElementById('results-content');
            showSection('results-section');

            try {
                // Get gap-addressing context
                const gapContext = document.getElementById('gap-context')?.value || '';
                
                // Create profile copy with conditional location
                const profileForResume = {...profileData};
                if (!shouldIncludeLocation()) {
                    profileForResume.location = '';
                }
                
                // Extract essential data
                const essentialProfile = {
                    name: profileForResume.name,
                    email: profileForResume.email,
                    phone: profileForResume.phone,
                    location: profileForResume.location,
                    linkedin: profileForResume.linkedin
                };
                
                const jobInfo = {
                    title: currentAnalysis.jobTitle,
                    company: currentAnalysis.company || 'target company',
                    matchScore: currentAnalysis.matchScore,
                    topStrengths: currentAnalysis.strengths?.slice(0, 5) || [],
                    keyRequirements: currentAnalysis.requirements?.slice(0, 8) || []
                };
                
                // CHUNK 1: Summary + Competencies
                updateResumeProgress('Generating professional summary...', 15);
                const summarySection = await generateSummarySection(
                    essentialProfile,
                    profileForResume.experience,
                    profileForResume.skills,
                    jobInfo,
                    gapContext
                );
                
                // CHUNK 2: Recent Experience
                updateResumeProgress('Generating recent work experience...', 35);
                const recentExperienceSection = await generateRecentExperience(
                    profileForResume.experience,
                    jobInfo,
                    gapContext
                );
                
                // CHUNK 3: Older Experience
                updateResumeProgress('Generating work history...', 55);
                const olderExperienceSection = await generateOlderExperience(
                    profileForResume.experience,
                    jobInfo
                );
                
                // CHUNK 4: Projects
                updateResumeProgress('Adding projects and technical work...', 70);
                const projectsSection = profileForResume.projects ? 
                    await generateProjectsSection(profileForResume.projects, jobInfo) : '';
                
                // CHUNK 5: Education & Certifications
                updateResumeProgress('Adding education and certifications...', 85);
                const educationSection = await generateEducationSection(
                    profileForResume.education,
                    profileForResume.certifications
                );
                
                // Combine sections
                updateResumeProgress('Finalizing resume...', 95);
                const fullResume = combineResumeSections(
                    summarySection,
                    recentExperienceSection,
                    olderExperienceSection,
                    projectsSection,
                    educationSection
                );
                
                // CHUNK 6: ATS Analysis
                updateResumeProgress('Running ATS analysis...', 98);
                const atsAnalysis = await generateATSAnalysis(fullResume, currentJobDescription);
                
                // Store for DOCX download
                currentResumeText = fullResume;
                currentResumeATS = atsAnalysis;
                
                // Save to generated files
                addGeneratedFile('resume', currentAnalysis.jobTitle, fullResume);
                
                // Re-analyze with generated resume
                const newAnalysis = await reAnalyzeWithResume(fullResume);
                const comparisonHtml = newAnalysis ? displayMatchComparison(currentAnalysis.matchScore, newAnalysis, null, atsAnalysis) : '';
                
                resultsContent.innerHTML = `
                    <h3>Your Tailored Resume</h3>
                    ${comparisonHtml}
                    ${displayATSBadge(atsAnalysis)}
                    <div class="document-output">${fullResume}</div>
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn-secondary" onclick="copyToClipboard(\`${fullResume.replace(/[`]/g, '\\`')}\`)">Copy Text</button>
                        <button class="btn-primary" onclick="downloadResumeAsDOCX()">Download as DOCX</button>
                    </div>
                    <div class="button-group" style="margin-top: 16px; border-top: 2px solid #e5e7eb; padding-top: 24px;">
                        <button class="btn-secondary" onclick="startNewJobAnalysis()">‚Üê Analyze Another Job</button>
                        <button class="btn-primary" onclick="generateCoverLetter()">Generate Cover Letter ‚Üí</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating resume:', error);
                resultsContent.innerHTML = `<div class="alert alert-danger">Error generating resume: ${error.message}. Please try again.</div>`;
            }
        }

        async function generateCoverLetter() {
            // Check acknowledgment first
            if (!checkAcknowledgmentBeforeGeneration(() => generateCoverLetter())) {
                return;
            }

            // Validate profile data exists
            if (!profileData) {
                alert('No profile data found. Please upload your resume first.');
                showSection('setup-section');
                return;
            }

            // Validate job analysis exists
            if (!currentAnalysis || !currentJobDescription) {
                alert('No job analysis found. Please analyze a job first.');
                showSection('job-analysis-section');
                return;
            }

            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating cover letter...</p></div>';
            showSection('results-section');

            try {
                // Create profile copy with conditional location
                const profileForCover = {...profileData};
                if (!shouldIncludeLocation()) {
                    profileForCover.location = '';
                }
                
                // Determine role seniority level
                const jobTitle = currentAnalysis.jobTitle.toLowerCase();
                const isSenior = jobTitle.includes('senior') || jobTitle.includes('sr.') || jobTitle.includes('lead');
                const isExecutive = jobTitle.includes('director') || jobTitle.includes('vp') || jobTitle.includes('chief') || jobTitle.includes('head of');
                const isManager = jobTitle.includes('manager') || jobTitle.includes('supervisor');
                
                // Set seniority level
                let seniorityLevel = 'mid';
                if (isExecutive) {
                    seniorityLevel = 'executive';
                } else if (isSenior || isManager) {
                    seniorityLevel = 'senior';
                }

                const systemPrompt = `You are writing a cover letter on behalf of a real person. This must sound like it was written by the candidate themselves, not an AI.

Candidate Profile:
${JSON.stringify(profileForCover, null, 2)}

Job Analysis:
${JSON.stringify(currentAnalysis, null, 2)}

ROLE SENIORITY LEVEL: ${seniorityLevel}

CRITICAL - ELIMINATE ALL AI TELLS:

BANNED PHRASES (never use these):
- "I am writing to express my interest"
- "I am excited to apply"
- "I believe I would be a great fit"
- "proven track record"
- "dynamic professional"
- "leverage my experience"
- "drive results"
- "passion for"
- "thrilled to"
- "I am confident that"
- Any variation of "delighted," "thrilled," or excessive enthusiasm

BANNED GREETINGS (never use these):
- "Hi there"
- "Hey there"
- "Hello"
- "Hi"
- "Hey"
- Any casual greeting
- ALWAYS use "Dear Hiring Manager," "Dear [Team] Team," or "Dear [Name]" if known

BANNED PUNCTUATION:
- Em dashes (‚Äî) - Maximum ONE per letter if absolutely necessary, prefer commas or periods
- Semicolons - Use periods instead for more natural writing
- Excessive ellipses (...) - Avoid entirely unless quoting

SENIORITY-BASED WRITING RULES:

${seniorityLevel === 'executive' ? `
EXECUTIVE LEVEL APPROACH:
- GREETING: Use "Dear Hiring Manager" or "Dear [Team] Hiring Team" - professional and direct
- OPENING: Lead with strategic insight or recent relevant achievement that shows executive-level thinking
- TONE: Authoritative but approachable. Position yourself as a peer, not a supplicant
- FOCUS: Strategic vision, organizational impact, leadership philosophy
- EXAMPLES: Use high-level metrics (revenue impact, team scale, organizational transformation)
- IMPERFECTIONS: Minimal - maintain executive presence (still use contractions for naturalness)
- COMPANY RESEARCH: Reference specific company initiatives, recent news, or strategic direction
- CLOSING: Suggest mutual exploration of fit. Never say "I can start immediately"
- LENGTH: 3-4 short paragraphs, 250-350 words max
` : seniorityLevel === 'senior' ? `
SENIOR LEVEL APPROACH:
- GREETING: Use "Dear Hiring Manager" or "Dear [Team] Team" - professional
- OPENING: Start with your current role/achievement that's directly relevant to this position
- TONE: Confident and professional with subtle personality. Expert but not stiff
- FOCUS: Cross-functional leadership, measurable impact, technical depth + strategic thinking
- EXAMPLES: Specific metrics with context (reduced X by Y%, led team of Z across N departments)
- IMPERFECTIONS: Use 1-2 contractions, vary sentence length, one brief personal connection
- COMPANY RESEARCH: Show you understand their business, mention relevant product/service if applicable
- CLOSING: Express interest in discussing how you'd contribute. Avoid "start immediately"
- LENGTH: 3 paragraphs, 200-300 words
` : `
MID-LEVEL APPROACH:
- GREETING: Use "Dear Hiring Manager" or "Dear [Team] Team" - professional always
- OPENING: Jump right in with why this role excites you right now - be direct
- TONE: Professional but conversational. Eager but not desperate
- FOCUS: Specific accomplishments, growth trajectory, relevant skills
- EXAMPLES: Concrete numbers and achievements from recent roles
- IMPERFECTIONS: Use contractions, vary sentence rhythm, can start with "And" or "But"
- COMPANY RESEARCH: Optional but good to mention if you know their product/values
- CLOSING: Can mention availability or next steps, but avoid "start immediately"
- LENGTH: 3 paragraphs, 200-250 words
`}

UNIVERSAL WRITING RULES (all levels):
1. GREETING: Always use "Dear Hiring Manager," "Dear [Team] Team," or "Dear [Name]" if known. NEVER use "Hi there," "Hey," or other casual greetings
2. Use short, punchy sentences mixed with longer ones (vary rhythm)
3. Be SPECIFIC with numbers and examples from their experience
4. Sound confident but not arrogant - use "I've" instead of "I have"
5. Use industry-specific terminology naturally
6. NO buzzwords or jargon unless the job description uses them
7. Show subtle personality while staying professional
8. Never end with "I look forward to hearing from you"

CRITICAL - TRUTHFULNESS REQUIREMENTS:
- ONLY mention skills, technologies, and experiences that are ACTUALLY in the candidate's profile
- NEVER claim skills from the job description that the candidate doesn't have
- NEVER exaggerate qualifications or add fabricated achievements
- If the candidate lacks a required skill, do NOT mention it or work around it
- Better to highlight relevant strengths honestly than claim false qualifications
- User is legally responsible for accuracy

STRUCTURE:
1. Opening (2-3 sentences): Hook them with relevance
2. Body (3-5 sentences): Proof through specific examples with metrics
3. Closing (1-2 sentences): Action-oriented next step

${seniorityLevel === 'senior' || seniorityLevel === 'executive' ? `
COMPANY RESEARCH REQUIREMENT:
Review the job description for company name, recent initiatives, products, or strategic goals mentioned.
Incorporate 1-2 specific references that show you understand their business context.
DO NOT make generic statements like "I admire your company" - be specific.
` : ''}

Generate the cover letter now. Match the tone and approach to the ${seniorityLevel} level.`;

                const coverLetter = await callClaudeAPI(systemPrompt, `Job Description:\n${currentJobDescription}`);
                
                // Store for DOCX download
                currentCoverLetterText = coverLetter;
                
                // Save to generated files
                addGeneratedFile('coverLetter', currentAnalysis.jobTitle, coverLetter);
                
                resultsContent.innerHTML = `
                    <h3>Your Cover Letter</h3>
                    <div class="document-output">${coverLetter}</div>
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn-secondary" onclick="copyToClipboard(\`${coverLetter.replace(/[`]/g, '\\`')}\`)">Copy Text</button>
                        <button class="btn-primary" onclick="downloadCoverLetterAsDOCX()">Download as DOCX</button>
                    </div>
                    <div class="button-group" style="margin-top: 16px; border-top: 2px solid #e5e7eb; padding-top: 24px;">
                        <button class="btn-secondary" onclick="startNewJobAnalysis()">‚Üê Analyze Another Job</button>
                        <button class="btn-primary" onclick="generateResume()">Generate Resume ‚Üí</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating cover letter:', error);
                resultsContent.innerHTML = `<div class="alert alert-danger">Error generating cover letter. Please try again.</div>`;
            }
        }

        async function downloadResumeAsDOCX() {
            const documentOutput = document.querySelector('#results-section .document-output');
            if (!documentOutput) {
                alert('No resume found to download. Please generate a resume first.');
                return;
            }

            // Validate profile data exists for filename
            if (!profileData || !profileData.name) {
                alert('Profile data missing. Please refresh and upload your resume again.');
                return;
            }
            
            const resumeText = documentOutput.textContent;
            console.log('First 200 chars:', resumeText.substring(0, 200));
            console.log('Contains newlines:', resumeText.includes('\n'));
            console.log('Contains **:', resumeText.includes('**'));
            console.log('Contains ##:', resumeText.includes('##'));
            console.log('=== END DEBUG ===');
            
            try {
                if (typeof JSZip === 'undefined') {
                    alert('Required library not loaded. Try refreshing the page.\n\nAlternative: Use "Copy Text" button and paste into Word.');
                    return;
                }

                const zip = new JSZip();
                
                zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);
                
                zip.folder('_rels').file('.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
                
                const wordFolder = zip.folder('word');
                wordFolder.folder('_rels').file('document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`);
                
                const HEADER_SPACING_BEFORE = 120;
                const JOB_SECTION_SPACING_AFTER = 80;
                
                const lines = resumeText.split('\n').filter(l => {
                    const t = l.trim();
                    return t && !/^[-*_]{3,}$/.test(t);
                });
                
                const paragraphs = lines.map((line, index) => {
                    let trimmed = line.trim();
                    
                    // Strip leading separators like "---## Header" ‚Üí "## Header"
                    trimmed = trimmed.replace(/^[-*_]{3,}\s*/, '');
                    
                    const headerMatch = trimmed.match(/^(#{1,6})\s+(.+)$/);
                    let headerLevel = 0;
                    if (headerMatch) {
                        headerLevel = headerMatch[1].length;
                        trimmed = headerMatch[2];
                    }
                    
                    const cleanLine = trimmed.replace(/\*\*/g, '');
                    const isAllCaps = cleanLine === cleanLine.toUpperCase() && cleanLine.length > 2;
                    const isHeader = headerLevel > 0 || isAllCaps;
                    
                    const isBullet = /^[-‚Ä¢]\s/.test(trimmed);
                    
                    let isLastBulletInSection = false;
                    if (isBullet && index < lines.length - 1) {
                        const nextLine = lines[index + 1].trim();
                        const nextIsBullet = /^[-‚Ä¢]\s/.test(nextLine);
                        if (!nextIsBullet) {
                            const hasBold = /\*\*/.test(nextLine);
                            if (hasBold) {
                                isLastBulletInSection = true;
                            }
                        }
                    }
                    
                    const parts = [];
                    const boldRegex = /\*\*(.+?)\*\*/g;
                    let lastIndex = 0;
                    let match;
                    
                    while ((match = boldRegex.exec(trimmed)) !== null) {
                        if (match.index > lastIndex) {
                            const beforeText = trimmed.substring(lastIndex, match.index);
                            if (beforeText) {
                                parts.push({ text: beforeText, bold: isHeader });
                            }
                        }
                        parts.push({ text: match[1], bold: true });
                        lastIndex = match.index + match[0].length;
                    }
                    
                    if (lastIndex < trimmed.length) {
                        const remainingText = trimmed.substring(lastIndex);
                        if (remainingText) {
                            parts.push({ text: remainingText, bold: isHeader });
                        }
                    }
                    
                    if (parts.length === 0) {
                        parts.push({ text: trimmed, bold: isHeader });
                    }
                    
                    const runs = parts.map(part => {
                        const escaped = part.text
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&apos;');
                        
                        const fontSize = isHeader ? 28 : 22;
                        const isBold = part.bold;
                        
                        return `<w:r><w:rPr><w:sz w:val="${fontSize}"/>${isBold ? '<w:b/>' : ''}</w:rPr><w:t xml:space="preserve">${escaped}</w:t></w:r>`;
                    }).join('');
                    
                    let spacingAfter = 0;
                    if (isLastBulletInSection) {
                        spacingAfter = JOB_SECTION_SPACING_AFTER;
                    }
                    const spacingBefore = isHeader ? HEADER_SPACING_BEFORE : 0;
                    
                    return `<w:p><w:pPr><w:spacing w:after="${spacingAfter}" w:before="${spacingBefore}"/></w:pPr>${runs}</w:p>`;
                }).join('');
                
                wordFolder.file('document.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    ${paragraphs}
  </w:body>
</w:document>`);
                
                const blob = await zip.generateAsync({type: 'blob'});
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${profileData.name.replace(/\s+/g, '_')}_Resume.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('DOCX Error:', error);
                alert(`Error creating DOCX: ${error.message}\n\nPlease use "Copy Text" button instead and paste into Word.`);
            }
        }

        async function downloadCoverLetterAsDOCX() {
            const documentOutput = document.querySelector('#results-section .document-output');
            if (!documentOutput) {
                alert('No cover letter found to download. Please generate a cover letter first.');
                return;
            }

            // Validate profile data exists for filename
            if (!profileData || !profileData.name) {
                alert('Profile data missing. Please refresh and upload your resume again.');
                return;
            }
            
            const coverLetterText = documentOutput.textContent;
            
            try {
                if (typeof JSZip === 'undefined') {
                    alert('Required library not loaded. Try refreshing the page.\n\nAlternative: Use "Copy Text" button and paste into Word.');
                    return;
                }

                const zip = new JSZip();
                
                zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);
                
                zip.folder('_rels').file('.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
                
                const wordFolder = zip.folder('word');
                wordFolder.folder('_rels').file('document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`);
                
                const textParagraphs = coverLetterText.split('\n\n').filter(p => p.trim() && !/^[-*_]{3,}$/.test(p.trim()));
                const xmlParagraphs = textParagraphs.map(para => {
                    const trimmed = para.trim();
                    
                    const parts = [];
                    const boldRegex = /\*\*(.+?)\*\*/g;
                    let lastIndex = 0;
                    let match;
                    
                    while ((match = boldRegex.exec(trimmed)) !== null) {
                        if (match.index > lastIndex) {
                            const beforeText = trimmed.substring(lastIndex, match.index);
                            if (beforeText) {
                                parts.push({ text: beforeText, bold: false });
                            }
                        }
                        parts.push({ text: match[1], bold: true });
                        lastIndex = match.index + match[0].length;
                    }
                    
                    if (lastIndex < trimmed.length) {
                        const remainingText = trimmed.substring(lastIndex);
                        if (remainingText) {
                            parts.push({ text: remainingText, bold: false });
                        }
                    }
                    
                    if (parts.length === 0) {
                        parts.push({ text: trimmed, bold: false });
                    }
                    
                    const runs = parts.map(part => {
                        const escaped = part.text
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&apos;');
                        
                        return `<w:r><w:rPr><w:sz w:val="22"/>${part.bold ? '<w:b/>' : ''}</w:rPr><w:t xml:space="preserve">${escaped}</w:t></w:r>`;
                    }).join('');
                    
                    return `<w:p><w:pPr><w:spacing w:after="240"/></w:pPr>${runs}</w:p>`;
                }).join('');
                
                wordFolder.file('document.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    ${xmlParagraphs}
  </w:body>
</w:document>`);
                
                const blob = await zip.generateAsync({type: 'blob'});
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${profileData.name.replace(/\s+/g, '_')}_CoverLetter.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('DOCX Error:', error);
                alert(`Error creating DOCX: ${error.message}\n\nPlease use "Copy Text" button instead and paste into Word.`);
            }
        }

        // ========================================
        // ACKNOWLEDGMENT MODAL FUNCTIONS
        // ========================================

        // Check if user has acknowledged
        function hasAcknowledged() {
            try {
                return localStorage.getItem('smartapply-acknowledged') === 'true';
            } catch (e) {
                return false;
            }
        }

        // Show acknowledgment modal
        function showAcknowledgmentModal() {
            const modal = document.getElementById('acknowledgment-modal');
            if (modal) {
                // Save the element that had focus before opening modal
                window.lastFocusedElement = document.activeElement;
                
                modal.classList.add('show');
                
                // Focus first checkbox after a brief delay
                setTimeout(() => {
                    document.getElementById('ack-check1')?.focus();
                }, 100);
                
                // Add focus trap
                modal.addEventListener('keydown', trapFocus);
            }
        }

        // Hide acknowledgment modal
        function hideAcknowledgmentModal() {
            const modal = document.getElementById('acknowledgment-modal');
            if (!modal) return;
            
            modal.classList.remove('show');
            
            // Remove focus trap
            modal.removeEventListener('keydown', trapFocus);
            
            // Restore focus to element that had it before modal opened
            if (window.lastFocusedElement && window.lastFocusedElement.focus) {
                window.lastFocusedElement.focus();
            }
            
            // Reset checkboxes
            modal.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateAcknowledgeButton();
        }

        // Focus trap function - keeps Tab within modal
        function trapFocus(e) {
            if (e.key !== 'Tab') return;
            
            const modal = document.getElementById('acknowledgment-modal');
            const focusableElements = modal.querySelectorAll(
                'input:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])'
            );
            
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];
            
            if (e.shiftKey) {
                // Shift + Tab - going backwards
                if (document.activeElement === firstFocusable) {
                    e.preventDefault();
                    lastFocusable.focus();
                }
            } else {
                // Tab - going forwards
                if (document.activeElement === lastFocusable) {
                    e.preventDefault();
                    firstFocusable.focus();
                }
            }
        }

        // Handle escape key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('acknowledgment-modal');
                if (modal && modal.classList.contains('show')) {
                    hideAcknowledgmentModal();
                }
            }
        });

        // Click outside modal to close
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('acknowledgment-modal');
            if (modal && modal.classList.contains('show')) {
                if (e.target === modal) {
                    hideAcknowledgmentModal();
                }
            }
        });

        // Update continue button state
        function updateAcknowledgeButton() {
            const allChecked = ['ack-check1', 'ack-check2', 'ack-check3', 'ack-check4']
                .every(id => document.getElementById(id)?.checked);
            const btn = document.getElementById('acknowledge-continue-btn');
            if (btn) {
                btn.disabled = !allChecked;
                btn.setAttribute('aria-disabled', !allChecked);
            }
        }

        // Handle acknowledgment
        function acknowledgeAndContinue() {
            try {
                localStorage.setItem('smartapply-acknowledged', 'true');
            } catch (e) {
                console.error('Could not save acknowledgment:', e);
            }
            hideAcknowledgmentModal();
            // Continue with whatever action triggered this
            if (window.pendingGenerationFunction) {
                window.pendingGenerationFunction();
                window.pendingGenerationFunction = null;
            }
        }

        // Wrap generation functions to check acknowledgment first
        function checkAcknowledgmentBeforeGeneration(generationFunction) {
            if (!hasAcknowledged()) {
                window.pendingGenerationFunction = generationFunction;
                showAcknowledgmentModal();
                return false;
            }
            return true;
        }
    </script>
    
    <!-- Footer Notice -->
    <div style="background: #f1f5f9; border-top: 2px solid #e2e8f0; padding: 16px 24px; text-align: center; color: #64748b; font-size: 13px; margin-top: 32px; border-radius: 8px;">
        <strong>Use SmartApply Responsibly.</strong> You are accountable for the accuracy of your application materials. 
        All qualifications must be truthful and verifiable. | 
        <a href="#" style="color: #14b8a6; text-decoration: none;" onclick="showSection('about-section'); return false;">Read Guidelines</a>
    </div>
    
        </main>
    
    <!-- Acknowledgment Modal -->
    <div id="acknowledgment-modal" 
         class="modal-overlay" 
         role="dialog" 
         aria-modal="true" 
         aria-labelledby="modal-title" 
         aria-describedby="modal-description">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title" style="color: white; font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è Before You Generate Documents</h2>
                <p id="modal-description" style="color: #cbd5e1; font-size: 14px;">Please review and acknowledge SmartApply's responsible use guidelines</p>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #0f172a; margin-bottom: 12px; font-size: 16px; font-weight: 700;">SmartApply is a Writing Assistant</h4>
                    <p style="color: #475569; line-height: 1.6;">Think of SmartApply like working with a professional resume writer or career coach. It helps you <strong>present your real qualifications</strong> in the best possible way.</p>
                </div>

                <div style="margin-bottom: 24px;">
                    <p style="color: #059669; font-weight: 600; margin-bottom: 8px;">‚úì SmartApply DOES:</p>
                    <ul style="color: #475569; padding-left: 24px; line-height: 1.6; margin-bottom: 16px;">
                        <li>Format your experience professionally</li>
                        <li>Help articulate your accomplishments</li>
                        <li>Tailor your qualifications to jobs</li>
                    </ul>
                    
                    <p style="color: #dc2626; font-weight: 600; margin-bottom: 8px;">‚úó SmartApply DOES NOT:</p>
                    <ul style="color: #475569; padding-left: 24px; line-height: 1.6;">
                        <li>Create fake experience or skills</li>
                        <li>Make up qualifications you don't have</li>
                        <li>Guarantee job offers</li>
                    </ul>
                </div>

                <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 24px 0;">
                    <div style="display: flex; align-items: start; margin-bottom: 16px;">
                        <input type="checkbox" id="ack-check1" onchange="updateAcknowledgeButton()" style="margin-right: 12px; margin-top: 4px; width: 20px; height: 20px; cursor: pointer;">
                        <label for="ack-check1" style="color: #1e293b; line-height: 1.5; cursor: pointer;">I understand that <strong>all information in my profile must be accurate and truthful</strong></label>
                    </div>
                    <div style="display: flex; align-items: start; margin-bottom: 16px;">
                        <input type="checkbox" id="ack-check2" onchange="updateAcknowledgeButton()" style="margin-right: 12px; margin-top: 4px; width: 20px; height: 20px; cursor: pointer;">
                        <label for="ack-check2" style="color: #1e293b; line-height: 1.5; cursor: pointer;">I can <strong>demonstrate and discuss all skills</strong> I've listed</label>
                    </div>
                    <div style="display: flex; align-items: start; margin-bottom: 16px;">
                        <input type="checkbox" id="ack-check3" onchange="updateAcknowledgeButton()" style="margin-right: 12px; margin-top: 4px; width: 20px; height: 20px; cursor: pointer;">
                        <label for="ack-check3" style="color: #1e293b; line-height: 1.5; cursor: pointer;">I will <strong>review and edit generated documents</strong> before submitting</label>
                    </div>
                    <div style="display: flex; align-items: start;">
                        <input type="checkbox" id="ack-check4" onchange="updateAcknowledgeButton()" style="margin-right: 12px; margin-top: 4px; width: 20px; height: 20px; cursor: pointer;">
                        <label for="ack-check4" style="color: #1e293b; line-height: 1.5; cursor: pointer;">I understand I'm <strong>responsible for application accuracy</strong>, not the AI tool</label>
                    </div>
                </div>

                <p style="color: #64748b; font-size: 14px; font-style: italic;">
                    Using AI writing assistance is standard practice and similar to using professional editing services. 
                    What matters is that your qualifications are true.
                </p>
            </div>
            <div style="padding: 24px 32px; border-top: 2px solid #e2e8f0; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn-secondary" 
                        onclick="hideAcknowledgmentModal()" 
                        aria-label="Cancel and close modal">Cancel</button>
                <button class="btn-primary" 
                        id="acknowledge-continue-btn" 
                        disabled 
                        onclick="acknowledgeAndContinue()" 
                        aria-label="I acknowledge and continue to generate documents" 
                        aria-disabled="true">I Acknowledge - Continue</button>
            </div>
        </div>
    </div>
    
    </div>
</body>
</html>